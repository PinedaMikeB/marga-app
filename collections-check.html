<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collections Data Check - Marga</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f5f5f5; }
        h1 { color: #333; margin-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { color: #e91e8c; margin-bottom: 15px; font-size: 18px; }
        .stat { display: inline-block; background: #f0f0f0; padding: 10px 20px; border-radius: 4px; margin: 5px; }
        .stat .count { font-size: 24px; font-weight: bold; color: #e91e8c; }
        .stat .label { font-size: 12px; color: #666; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .loading { color: #666; font-style: italic; }
        .error { color: #d32f2f; }
        .success { color: #388e3c; }
        button { background: #e91e8c; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #c2185b; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f5f5f5; font-weight: 600; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; }
        .badge-rtp { background: #e3f2fd; color: #1976d2; }
        .badge-rtf { background: #f3e5f5; color: #7b1fa2; }
    </style>
</head>
<body>
    <h1>üîç Collections Data Check</h1>
    
    <div class="card">
        <h2>Firebase Collections Status</h2>
        <div id="collections-status">
            <p class="loading">Checking collections...</p>
        </div>
    </div>

    <div class="card">
        <h2>Billing Records (tbl_invoicenum)</h2>
        <button onclick="checkBillingRecords()">Check Billing Records</button>
        <button onclick="getSampleInvoices()">Get Sample Invoices</button>
        <div id="billing-status"></div>
    </div>

    <div class="card">
        <h2>Payment Records (tbl_paymentinfo)</h2>
        <button onclick="checkPaymentRecords()">Check Payment Records</button>
        <div id="payment-status"></div>
    </div>

    <div class="card">
        <h2>Unpaid Invoices Query</h2>
        <button onclick="findUnpaidInvoices()">Find Unpaid Invoices (Sample)</button>
        <div id="unpaid-status"></div>
    </div>

    <div class="card">
        <h2>Collection History (tbl_collectionhistory)</h2>
        <button onclick="checkCollectionHistory()">Check Collection History</button>
        <div id="collection-status"></div>
    </div>

    <script src="shared/js/firebase-config.js"></script>
    <script>
        const API_KEY = FIREBASE_CONFIG.apiKey;
        const BASE_URL = FIREBASE_CONFIG.baseUrl;

        // Helper to fetch from Firestore
        async function firestoreQuery(collection, pageSize = 10) {
            const url = `${BASE_URL}/${collection}?pageSize=${pageSize}&key=${API_KEY}`;
            const response = await fetch(url);
            return response.json();
        }

        // Check what collections exist
        async function checkCollections() {
            const collections = [
                'tbl_invoicenum',      // Billing/Invoices
                'tbl_billing',          // Alternative billing table
                'tbl_paymentinfo',      // Payments
                'tbl_collectionhistory', // Collection follow-up history
                'tbl_collectioninfo',   // Collection info
                'tbl_schedule',         // Schedules
                'tbl_companylist',      // Companies
                'tbl_branchinfo',       // Branches
                'tbl_contractmain',     // Contracts
                'tbl_machine',          // Machines
                'tbl_particulars'       // Categories (RTP, RTF, etc.)
            ];

            const status = document.getElementById('collections-status');
            status.innerHTML = '<p class="loading">Checking collections...</p>';

            let html = '<table><tr><th>Collection</th><th>Status</th><th>Sample Count</th></tr>';

            for (const coll of collections) {
                try {
                    const data = await firestoreQuery(coll, 1);
                    const count = data.documents ? data.documents.length : 0;
                    const hasData = count > 0 ? '‚úÖ Has Data' : '‚ö†Ô∏è Empty';
                    html += `<tr><td>${coll}</td><td class="${count > 0 ? 'success' : 'error'}">${hasData}</td><td>${count > 0 ? 'Yes' : 'No'}</td></tr>`;
                } catch (e) {
                    html += `<tr><td>${coll}</td><td class="error">‚ùå Not Found</td><td>-</td></tr>`;
                }
            }

            html += '</table>';
            status.innerHTML = html;
        }

        // Check billing records
        async function checkBillingRecords() {
            const status = document.getElementById('billing-status');
            status.innerHTML = '<p class="loading">Checking billing records...</p>';

            try {
                // Try tbl_invoicenum first
                const data = await firestoreQuery('tbl_invoicenum', 5);
                
                if (data.documents && data.documents.length > 0) {
                    const sample = data.documents[0].fields;
                    status.innerHTML = `
                        <p class="success">‚úÖ Found billing records in tbl_invoicenum</p>
                        <p><strong>Sample record fields:</strong></p>
                        <pre>${JSON.stringify(sample, null, 2)}</pre>
                    `;
                } else {
                    // Try tbl_billing
                    const billing = await firestoreQuery('tbl_billing', 5);
                    if (billing.documents && billing.documents.length > 0) {
                        const sample = billing.documents[0].fields;
                        status.innerHTML = `
                            <p class="success">‚úÖ Found billing records in tbl_billing</p>
                            <p><strong>Sample record fields:</strong></p>
                            <pre>${JSON.stringify(sample, null, 2)}</pre>
                        `;
                    } else {
                        status.innerHTML = '<p class="error">‚ùå No billing records found</p>';
                    }
                }
            } catch (e) {
                status.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        // Get sample invoices with more details
        async function getSampleInvoices() {
            const status = document.getElementById('billing-status');
            status.innerHTML = '<p class="loading">Fetching sample invoices...</p>';

            try {
                const data = await firestoreQuery('tbl_invoicenum', 20);
                
                if (data.documents && data.documents.length > 0) {
                    let html = '<p class="success">‚úÖ Sample Invoices:</p>';
                    html += '<table><tr><th>Invoice #</th><th>Contract ID</th><th>Amount</th><th>Month/Year</th><th>Date</th></tr>';
                    
                    data.documents.forEach(doc => {
                        const f = doc.fields;
                        const getValue = (field) => {
                            if (!field) return '-';
                            return field.integerValue || field.stringValue || field.doubleValue || '-';
                        };
                        
                        html += `<tr>
                            <td>${getValue(f.id) || getValue(f.invoice_id) || getValue(f.invoiceno)}</td>
                            <td>${getValue(f.contract_id) || getValue(f.contractid)}</td>
                            <td>‚Ç±${getValue(f.amount) || getValue(f.total) || getValue(f.totalamount)}</td>
                            <td>${getValue(f.invmonth) || getValue(f.month)}/${getValue(f.invyear) || getValue(f.year)}</td>
                            <td>${getValue(f.invdate) || getValue(f.date) || getValue(f.dateprinted)}</td>
                        </tr>`;
                    });
                    
                    html += '</table>';
                    status.innerHTML = html;
                } else {
                    status.innerHTML = '<p class="error">No invoices found</p>';
                }
            } catch (e) {
                status.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        // Check payment records
        async function checkPaymentRecords() {
            const status = document.getElementById('payment-status');
            status.innerHTML = '<p class="loading">Checking payment records...</p>';

            try {
                const data = await firestoreQuery('tbl_paymentinfo', 5);
                
                if (data.documents && data.documents.length > 0) {
                    const sample = data.documents[0].fields;
                    status.innerHTML = `
                        <p class="success">‚úÖ Found payment records</p>
                        <p><strong>Sample record fields:</strong></p>
                        <pre>${JSON.stringify(sample, null, 2)}</pre>
                    `;
                } else {
                    status.innerHTML = '<p class="error">‚ùå No payment records found</p>';
                }
            } catch (e) {
                status.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        // Check collection history
        async function checkCollectionHistory() {
            const status = document.getElementById('collection-status');
            status.innerHTML = '<p class="loading">Checking collection history...</p>';

            try {
                const data = await firestoreQuery('tbl_collectionhistory', 5);
                
                if (data.documents && data.documents.length > 0) {
                    const sample = data.documents[0].fields;
                    status.innerHTML = `
                        <p class="success">‚úÖ Found collection history records</p>
                        <p><strong>Sample record fields:</strong></p>
                        <pre>${JSON.stringify(sample, null, 2)}</pre>
                    `;
                } else {
                    status.innerHTML = '<p class="error">‚ö†Ô∏è No collection history found (might need to be created)</p>';
                }
            } catch (e) {
                status.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        // Find unpaid invoices (invoices without payments)
        async function findUnpaidInvoices() {
            const status = document.getElementById('unpaid-status');
            status.innerHTML = '<p class="loading">Finding unpaid invoices (this is a complex query)...</p>';

            try {
                // Get some invoices
                const invoices = await firestoreQuery('tbl_invoicenum', 50);
                
                if (!invoices.documents || invoices.documents.length === 0) {
                    status.innerHTML = '<p class="error">No invoices found to check</p>';
                    return;
                }

                // Get payments
                const payments = await firestoreQuery('tbl_paymentinfo', 100);
                const paidInvoiceIds = new Set();
                
                if (payments.documents) {
                    payments.documents.forEach(doc => {
                        const f = doc.fields;
                        const invoiceId = f.invoice_id?.integerValue || f.invoiceno?.integerValue || f.inv_id?.integerValue;
                        if (invoiceId) paidInvoiceIds.add(invoiceId);
                    });
                }

                // Find unpaid
                const unpaid = invoices.documents.filter(doc => {
                    const f = doc.fields;
                    const id = f.id?.integerValue || f.invoice_id?.integerValue;
                    return !paidInvoiceIds.has(id);
                });

                let html = `<p class="success">Found ${unpaid.length} potentially unpaid invoices (from sample of ${invoices.documents.length})</p>`;
                html += `<p><em>Note: ${paidInvoiceIds.size} paid invoice IDs found in payments sample</em></p>`;
                
                if (unpaid.length > 0) {
                    html += '<table><tr><th>Invoice #</th><th>Contract ID</th><th>Amount</th><th>Month/Year</th></tr>';
                    unpaid.slice(0, 10).forEach(doc => {
                        const f = doc.fields;
                        const getValue = (field) => field?.integerValue || field?.stringValue || field?.doubleValue || '-';
                        html += `<tr>
                            <td>${getValue(f.id)}</td>
                            <td>${getValue(f.contract_id)}</td>
                            <td>‚Ç±${getValue(f.amount) || getValue(f.totalamount)}</td>
                            <td>${getValue(f.invmonth)}/${getValue(f.invyear)}</td>
                        </tr>`;
                    });
                    html += '</table>';
                }

                status.innerHTML = html;
            } catch (e) {
                status.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        // Run initial check
        checkCollections();
    </script>
</body>
</html>
