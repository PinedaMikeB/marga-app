<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARGA - Sync Latest</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif; 
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .header p { opacity: 0.8; }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            font-size: 1.1rem;
            color: #1e3a5f;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .config-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .config-group {
            flex: 1;
            min-width: 200px;
        }
        
        .config-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.5rem;
        }
        
        .config-group input, .config-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .config-group input:focus, .config-group select:focus {
            outline: none;
            border-color: #2d5a87;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 1.25rem;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e3a5f;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            width: 100%;
            justify-content: center;
            font-size: 1.1rem;
            padding: 1.25rem;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
        }
        
        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            padding: 0.75rem 1.5rem;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .progress-section {
            margin: 1.5rem 0;
            display: none;
        }
        
        .progress-section.visible {
            display: block;
        }
        
        .progress {
            background: #e2e8f0;
            border-radius: 10px;
            height: 16px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .table-status {
            margin-top: 1rem;
        }
        
        .table-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .table-name {
            font-weight: 500;
            color: #334155;
        }
        
        .table-count {
            color: #64748b;
        }
        
        .table-status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-syncing { background: #dbeafe; color: #1e40af; }
        .status-done { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #991b1b; }
        
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .log .time { color: #64748b; }
        .log .success { color: #4ade80; }
        .log .error { color: #f87171; }
        .log .info { color: #60a5fa; }
        
        .last-sync-banner {
            background: linear-gradient(135deg, #d1fae5 0%, #bbf7d0 100%);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .last-sync-banner svg {
            color: #16a34a;
            flex-shrink: 0;
        }
        
        .last-sync-info {
            flex: 1;
        }
        
        .last-sync-label {
            font-size: 0.8rem;
            color: #166534;
        }
        
        .last-sync-date {
            font-weight: 600;
            color: #15803d;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }
        
        .api-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #94a3b8;
        }
        
        .api-dot.online { background: #22c55e; }
        .api-dot.offline { background: #ef4444; }
        
        .quick-dates {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .quick-date {
            padding: 0.375rem 0.75rem;
            background: #f1f5f9;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #475569;
        }
        
        .quick-date:hover {
            background: #e2e8f0;
        }
        
        .actions-row {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ Sync Latest</h1>
            <p>One-click sync from MySQL to Firebase</p>
        </div>
        
        <!-- API Status -->
        <div class="card">
            <div class="api-status">
                <div class="api-dot" id="apiDot"></div>
                <span id="apiStatus">Checking API connection...</span>
            </div>
            
            <h2>‚öôÔ∏è Sync Configuration</h2>
            
            <div class="config-row">
                <div class="config-group">
                    <label>API Endpoint URL</label>
                    <input type="text" id="apiUrl" value="https://your-server.com/marga/sync/api.php" placeholder="https://your-server.com/api.php">
                </div>
                <div class="config-group">
                    <label>Sync Records Since</label>
                    <input type="datetime-local" id="sinceDate">
                    <div class="quick-dates">
                        <button class="quick-date" onclick="setQuickDate('today')">Today</button>
                        <button class="quick-date" onclick="setQuickDate('yesterday')">Yesterday</button>
                        <button class="quick-date" onclick="setQuickDate('week')">Last 7 days</button>
                        <button class="quick-date" onclick="setQuickDate('month')">Last 30 days</button>
                    </div>
                </div>
            </div>
            
            <div class="actions-row">
                <button class="btn btn-secondary" onclick="checkApi()">üîç Test Connection</button>
                <button class="btn btn-secondary" onclick="previewSync()">üìä Preview Changes</button>
            </div>
        </div>
        
        <!-- Stats & Sync -->
        <div class="card">
            <div class="last-sync-banner" id="lastSyncBanner" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                    <path d="M22 4L12 14.01l-3-3"/>
                </svg>
                <div class="last-sync-info">
                    <div class="last-sync-label">Last Successful Sync</div>
                    <div class="last-sync-date" id="lastSyncDate">-</div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="statTables">-</div>
                    <div class="stat-label">Tables to Sync</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statRecords">-</div>
                    <div class="stat-label">New Records</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statSynced">0</div>
                    <div class="stat-label">Synced</div>
                </div>
            </div>
            
            <div class="progress-section" id="progressSection">
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                <div class="progress-text">
                    <span id="progressText">Preparing...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btnSync" onclick="startSync()" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="22" height="22">
                    <path d="M23 4v6h-6"/>
                    <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                </svg>
                Start Sync
            </button>
            
            <div class="table-status" id="tableStatus"></div>
        </div>
        
        <!-- Log -->
        <div class="card">
            <h2>üìã Sync Log</h2>
            <div class="log" id="log">
                <div><span class="time">[Ready]</span> Configure API endpoint and click "Test Connection"</div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shared/js/firebase-config.js"></script>
    
    <script>
        // Initialize Firebase
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();
        
        let syncData = {};
        let totalRecords = 0;
        let syncedRecords = 0;
        
        // Set default date to yesterday
        document.addEventListener('DOMContentLoaded', () => {
            setQuickDate('yesterday');
            loadSavedConfig();
            loadLastSync();
        });
        
        function setQuickDate(preset) {
            const input = document.getElementById('sinceDate');
            const now = new Date();
            let date;
            
            switch(preset) {
                case 'today':
                    date = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'yesterday':
                    date = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    break;
                case 'week':
                    date = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                    break;
                case 'month':
                    date = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
                    break;
            }
            
            input.value = date.toISOString().slice(0, 16);
        }
        
        function loadSavedConfig() {
            const savedUrl = localStorage.getItem('marga_sync_api_url');
            if (savedUrl) {
                document.getElementById('apiUrl').value = savedUrl;
                checkApi();
            }
        }
        
        function saveConfig() {
            localStorage.setItem('marga_sync_api_url', document.getElementById('apiUrl').value);
        }
        
        async function checkApi() {
            const apiUrl = document.getElementById('apiUrl').value;
            const dot = document.getElementById('apiDot');
            const status = document.getElementById('apiStatus');
            
            saveConfig();
            log('Testing API connection...', 'info');
            
            try {
                const response = await fetch(`${apiUrl}?action=status`);
                const data = await response.json();
                
                if (data.status === 'online') {
                    dot.className = 'api-dot online';
                    status.textContent = `‚úÖ Connected - ${data.tables.length} tables available`;
                    document.getElementById('btnSync').disabled = false;
                    log(`API online. Server time: ${data.server_time}`, 'success');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (e) {
                dot.className = 'api-dot offline';
                status.textContent = `‚ùå Connection failed: ${e.message}`;
                document.getElementById('btnSync').disabled = true;
                log(`API error: ${e.message}`, 'error');
            }
        }
        
        async function previewSync() {
            const apiUrl = document.getElementById('apiUrl').value;
            const since = document.getElementById('sinceDate').value;
            
            if (!since) {
                alert('Please select a date');
                return;
            }
            
            log(`Counting records since ${since}...`, 'info');
            
            try {
                const response = await fetch(`${apiUrl}?action=count&since=${encodeURIComponent(since)}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                totalRecords = data.total;
                const tablesWithData = Object.entries(data.counts).filter(([k, v]) => v > 0);
                
                document.getElementById('statTables').textContent = tablesWithData.length;
                document.getElementById('statRecords').textContent = totalRecords.toLocaleString();
                
                // Show table breakdown
                const tableStatus = document.getElementById('tableStatus');
                tableStatus.innerHTML = tablesWithData.map(([table, count]) => `
                    <div class="table-item" id="table-${table}">
                        <span class="table-name">${table}</span>
                        <span class="table-count">${count.toLocaleString()} records</span>
                    </div>
                `).join('');
                
                log(`Found ${totalRecords.toLocaleString()} records in ${tablesWithData.length} tables`, 'success');
                
                if (totalRecords > 0) {
                    document.getElementById('btnSync').disabled = false;
                }
                
            } catch (e) {
                log(`Error: ${e.message}`, 'error');
            }
        }
        
        async function startSync() {
            const apiUrl = document.getElementById('apiUrl').value;
            const since = document.getElementById('sinceDate').value;
            
            if (!since) {
                alert('Please select a date');
                return;
            }
            
            document.getElementById('btnSync').disabled = true;
            document.getElementById('progressSection').classList.add('visible');
            syncedRecords = 0;
            
            log('Starting sync...', 'info');
            
            try {
                // Fetch all data from API
                const response = await fetch(`${apiUrl}?action=fetchall&since=${encodeURIComponent(since)}`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                totalRecords = data.total;
                log(`Fetched ${totalRecords.toLocaleString()} records from MySQL`, 'success');
                
                // Sync each table to Firebase
                for (const [tableName, records] of Object.entries(data.tables)) {
                    log(`Syncing ${tableName}...`, 'info');
                    await syncTableToFirebase(tableName, records);
                }
                
                // Save sync timestamp
                await saveSyncTimestamp(since);
                
                log('üéâ Sync complete!', 'success');
                
            } catch (e) {
                log(`Sync error: ${e.message}`, 'error');
            }
            
            document.getElementById('btnSync').disabled = false;
        }
        
        async function syncTableToFirebase(tableName, records) {
            const BATCH_SIZE = 500;
            
            for (let i = 0; i < records.length; i += BATCH_SIZE) {
                const batch = db.batch();
                const chunk = records.slice(i, i + BATCH_SIZE);
                
                for (const record of chunk) {
                    const docId = String(record.id || Math.random().toString(36).substr(2, 9));
                    const docRef = db.collection(tableName).doc(docId);
                    batch.set(docRef, record, { merge: true });
                }
                
                await batch.commit();
                syncedRecords += chunk.length;
                updateProgress();
            }
            
            log(`‚úÖ ${tableName}: ${records.length.toLocaleString()} records synced`, 'success');
        }
        
        function updateProgress() {
            const percent = totalRecords > 0 ? Math.round((syncedRecords / totalRecords) * 100) : 0;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${syncedRecords.toLocaleString()} / ${totalRecords.toLocaleString()}`;
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('statSynced').textContent = syncedRecords.toLocaleString();
        }
        
        async function saveSyncTimestamp(since) {
            await db.collection('_sync_meta').doc('last_sync').set({
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                since: since,
                records_synced: syncedRecords
            });
            loadLastSync();
        }
        
        async function loadLastSync() {
            try {
                const doc = await db.collection('_sync_meta').doc('last_sync').get();
                if (doc.exists) {
                    const data = doc.data();
                    const date = data.timestamp?.toDate();
                    if (date) {
                        document.getElementById('lastSyncBanner').style.display = 'flex';
                        document.getElementById('lastSyncDate').textContent = 
                            date.toLocaleDateString('en-US', { 
                                weekday: 'short', month: 'short', day: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                            }) + ` (${data.records_synced?.toLocaleString() || 0} records)`;
                    }
                }
            } catch (e) {
                console.error('Error loading last sync:', e);
            }
        }
        
        function log(message, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div><span class="time">[${time}]</span> <span class="${type}">${message}</span></div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>
