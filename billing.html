<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARGA - Billing Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared/css/styles.css">
    <link rel="stylesheet" href="shared/css/dashboard.css">
    <style>
        /* 3-Panel Layout Styles */
        .billing-panels {
            display: grid;
            grid-template-columns: 1fr 1fr 320px;
            gap: 1rem;
            padding: 0 1rem 1rem;
            height: calc(100vh - 200px);
            min-height: 500px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .panel-header {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .panel-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1e3a5f;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-title .icon {
            font-size: 1.1rem;
        }
        
        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge.blue { background: #dbeafe; color: #1e40af; }
        .badge.orange { background: #fed7aa; color: #9a3412; }
        .badge.green { background: #d1fae5; color: #065f46; }
        .badge.red { background: #fee2e2; color: #dc2626; }
        
        .panel-toolbar {
            padding: 0.5rem 0.75rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .filter-btn {
            padding: 0.4rem 0.75rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            color: #64748b;
            font-weight: 500;
            transition: all 0.15s;
        }
        .filter-btn:hover { background: #f1f5f9; }
        .filter-btn.active { 
            background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); 
            color: white; 
            border-color: #1e3a5f; 
        }
        
        .search-input {
            flex: 1;
            min-width: 120px;
            padding: 0.4rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .search-input:focus {
            outline: none;
            border-color: #2d5a87;
            box-shadow: 0 0 0 2px rgba(45,90,135,0.1);
        }
        
        .panel-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .panel-footer {
            padding: 0.75rem;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Contract Items */
        .contract-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            display: grid;
            grid-template-columns: 42px 1fr auto;
            gap: 0.75rem;
            align-items: center;
            transition: background 0.15s;
        }
        .contract-item:hover { background: #f8fafc; }
        .contract-item.selected { 
            background: #eff6ff; 
            border-left: 3px solid #2d5a87; 
            padding-left: calc(1rem - 3px);
        }
        .contract-item.done { 
            opacity: 0.6; 
            background: #f0fdf4; 
        }
        .contract-item.fixed-rate { 
            border-left: 3px solid #8b5cf6; 
            padding-left: calc(1rem - 3px);
        }
        
        .rd-day {
            width: 42px; 
            height: 42px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.95rem;
            background: #e0e7ff;
            color: #3730a3;
        }
        .rd-day.today { 
            background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); 
            color: white; 
        }
        .rd-day.overdue { 
            background: #fee2e2; 
            color: #dc2626; 
        }
        
        .contract-info { 
            min-width: 0; 
        }
        .client-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: #1e3a5f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .contract-meta {
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            gap: 0.5rem;
            margin-top: 0.2rem;
            flex-wrap: wrap;
        }
        .contract-meta span {
            white-space: nowrap;
        }
        
        .contract-badges { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 0.25rem; 
        }
        .type-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .type-badge.rtp { background: #fef3c7; color: #92400e; }
        .type-badge.rtf { background: #dbeafe; color: #1e40af; }
        .type-badge.ref { background: #e0e7ff; color: #5b21b6; }
        .type-badge.fixed { background: #f3e8ff; color: #7c3aed; }
        
        .amount-preview {
            font-size: 0.8rem;
            font-weight: 600;
            color: #1e3a5f;
        }
        
        /* Invoice Items in Panel 2 & 3 */
        .reading-item, .invoice-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
        }
        .reading-item:hover, .invoice-item:hover { background: #f8fafc; }
        .reading-item.selected, .invoice-item.selected { 
            background: #eff6ff; 
            border-left: 3px solid #2d5a87;
            padding-left: calc(1rem - 3px);
        }
        .invoice-item.old { background: #fef9c3; }
        
        .reading-info, .invoice-info { flex: 1; min-width: 0; }
        .reading-client, .invoice-num { 
            font-weight: 600; 
            font-size: 0.85rem; 
            color: #1e3a5f; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reading-meta, .invoice-client { 
            font-size: 0.75rem; 
            color: #64748b; 
            margin-top: 0.15rem;
        }
        .reading-amount, .invoice-amount { 
            font-weight: 600; 
            font-size: 0.9rem; 
            color: #065f46; 
            text-align: right;
        }
        
        .age-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
            margin-top: 0.25rem;
            display: inline-block;
        }
        .age-badge.new { background: #d1fae5; color: #065f46; }
        .age-badge.medium { background: #fef3c7; color: #92400e; }
        .age-badge.old { background: #fee2e2; color: #dc2626; }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            flex: 1;
            transition: all 0.15s;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); 
            color: white; 
        }
        .btn-success { 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            color: white; 
        }
        .btn-secondary { 
            background: white; 
            color: #475569; 
            border: 1px solid #e2e8f0; 
        }
        .btn:hover:not(:disabled) { 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
        }
        .btn svg { width: 16px; height: 16px; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: #94a3b8;
        }
        .empty-state svg { 
            width: 48px; 
            height: 48px; 
            margin-bottom: 0.75rem; 
            opacity: 0.4; 
        }
        .empty-state p {
            font-size: 0.85rem;
        }
        
        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding: 1rem;
            margin: 0 1rem 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .stat-item {
            text-align: center;
            padding: 0.75rem;
            border-radius: 10px;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
        }
        .stat-item:hover { background: #f1f5f9; }
        .stat-item.active { 
            border-color: #2d5a87; 
            background: #eff6ff; 
        }
        .stat-value { 
            font-size: 1.75rem; 
            font-weight: 700; 
            color: #1e3a5f; 
        }
        .stat-label { 
            font-size: 0.75rem; 
            color: #64748b; 
            margin-top: 0.25rem; 
        }
        .stat-item.warning { background: #fef3c7; }
        .stat-item.warning .stat-value { color: #92400e; }
        .stat-item.success { background: #d1fae5; }
        .stat-item.success .stat-value { color: #065f46; }
        
        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #2d5a87;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .billing-panels { 
                grid-template-columns: 1fr 1fr; 
                height: auto;
            }
            .billing-panels .panel:last-child { 
                grid-column: span 2; 
            }
        }
        @media (max-width: 768px) {
            .billing-panels { 
                grid-template-columns: 1fr; 
            }
            .billing-panels .panel { 
                min-height: 350px; 
            }
            .billing-panels .panel:last-child { 
                grid-column: span 1; 
            }
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #1e3a5f;
            color: white;
            padding: 0.875rem 1.25rem;
            border-radius: 10px;
            font-size: 0.85rem;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .toast.show { display: flex; align-items: center; gap: 0.5rem; animation: slideUp 0.3s; }
        .toast.success { background: #16a34a; }
        .toast.error { background: #dc2626; }
        @keyframes slideUp { 
            from { transform: translateY(20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
    </style>
</head>
<body>
    <!-- Sidebar (same as original) -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="10" fill="url(#logo-gradient)"/>
                    <path d="M10 28V12h4l4 10 4-10h4v16h-3V17l-4 11h-2l-4-11v11H10z" fill="white"/>
                    <defs>
                        <linearGradient id="logo-gradient" x1="0" y1="0" x2="40" y2="40">
                            <stop stop-color="#4299e1"/>
                            <stop offset="1" stop-color="#3182ce"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="logo-text">MARGA<span>.</span></span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-title">Main Menu</div>
                <a href="dashboard.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Dashboard
                </a>
                <a href="customers.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
                    Customers
                </a>
                <a href="billing.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                    Billing
                </a>
                <a href="#" class="nav-item disabled">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                    Collections
                </a>
                <a href="#" class="nav-item disabled">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
                    Service
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">M</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">...</div>
                </div>
                <button class="logout-btn" onclick="MargaAuth.logout()" title="Logout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="main-header">
            <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            </button>
            <div class="header-title">
                <h1>Billing Dashboard</h1>
                <p>Meter readings ‚Ä¢ Invoice generation ‚Ä¢ Delivery tracking</p>
            </div>
            <div class="header-actions">
                <div class="date-selector">
                    <input type="date" id="billingDate" class="date-input">
                </div>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item active" onclick="setQuickFilter('today')">
                <div class="stat-value" id="statToday">0</div>
                <div class="stat-label">For Reading Today</div>
            </div>
            <div class="stat-item warning" onclick="setQuickFilter('forInvoice')">
                <div class="stat-value" id="statForInvoice">0</div>
                <div class="stat-label">Ready for Invoice</div>
            </div>
            <div class="stat-item" onclick="setQuickFilter('pending')">
                <div class="stat-value" id="statPending">0</div>
                <div class="stat-label">Pending Delivery</div>
            </div>
            <div class="stat-item success">
                <div class="stat-value" id="statCompleted">0</div>
                <div class="stat-label">Completed Today</div>
            </div>
        </div>

        <!-- 3-Panel Layout -->
        <div class="billing-panels">
            <!-- Panel 1: For Reading -->
            <div class="panel" id="panelForReading">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üìñ</span>
                        For Reading
                        <span class="badge blue" id="forReadingCount">0</span>
                    </div>
                </div>
                <div class="panel-toolbar">
                    <button class="filter-btn active" data-filter="today" onclick="setReadingFilter('today')">Today</button>
                    <button class="filter-btn" data-filter="overdue" onclick="setReadingFilter('overdue')">Overdue</button>
                    <button class="filter-btn" data-filter="all" onclick="setReadingFilter('all')">All</button>
                    <input type="text" class="search-input" placeholder="Search client..." id="searchReading" oninput="renderForReadingPanel()">
                </div>
                <div class="panel-body" id="forReadingList">
                    <div class="empty-state">
                        <div class="spinner"></div>
                        <p>Loading contracts...</p>
                    </div>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-primary" onclick="openBillingModal()" id="btnEnterReading" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        Enter Reading
                    </button>
                </div>
            </div>

            <!-- Panel 2: For Invoice -->
            <div class="panel" id="panelForInvoice">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üìÑ</span>
                        For Invoice
                        <span class="badge orange" id="forInvoiceCount">0</span>
                    </div>
                </div>
                <div class="panel-toolbar">
                    <input type="text" class="search-input" placeholder="Search readings..." id="searchForInvoice" oninput="renderForInvoicePanel()" style="flex:1;">
                </div>
                <div class="panel-body" id="forInvoiceList">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        <p>No readings pending invoice</p>
                    </div>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-success" onclick="generateSelectedInvoice()" id="btnGenerate" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Generate Invoice
                    </button>
                    <button class="btn btn-secondary" onclick="generateAllInvoices()" id="btnGenerateAll" disabled>All</button>
                </div>
            </div>

            <!-- Panel 3: Pending Delivery -->
            <div class="panel" id="panelPending">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üì¨</span>
                        Pending Delivery
                        <span class="badge green" id="pendingCount">0</span>
                    </div>
                </div>
                <div class="panel-body" id="pendingList">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>
                        <p>No pending invoices</p>
                    </div>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-secondary" onclick="assignToMessenger()" id="btnAssign" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                        Assign Messenger
                    </button>
                </div>
            </div>
        </div>
    </main>


    <!-- Invoice Number Modal -->
    <div class="modal-overlay" id="invoiceModalOverlay"></div>
    <div class="billing-modal" id="invoiceModal">
        <div class="billing-modal-header">
            <h3>Enter Invoice Details</h3>
            <button class="modal-close-btn" onclick="closeInvoiceModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="billing-modal-body">
            <div class="selected-contract-info" id="selectedContractInfo">
                <!-- Contract info will be populated here -->
            </div>
            <div class="invoice-form">
                <div class="form-field">
                    <label class="field-label">Invoice Number</label>
                    <input type="text" id="invoiceNumber" class="field-input" placeholder="Enter pre-printed invoice number">
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="field-label">Billing Month</label>
                        <select id="billingMonth" class="field-select">
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="field-label">Billing Year</label>
                        <select id="billingYear" class="field-select">
                            <!-- Years will be populated -->
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="billing-modal-footer">
            <button class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
            <button class="btn btn-primary" onclick="proceedToReading()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
                Proceed
            </button>
        </div>
    </div>

    <!-- Meter Reading Modal (preserving original functionality) -->
    <div class="modal-overlay" id="readingModalOverlay"></div>
    <div class="billing-modal reading-modal" id="readingModal">
        <div class="billing-modal-header">
            <h3>Billing Details</h3>
            <button class="modal-close-btn" onclick="closeReadingModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="billing-modal-body">
            <!-- Contract Header Info -->
            <div class="contract-header-info" id="contractHeaderInfo"></div>

            <!-- Reading Form -->
            <div class="reading-form-layout">
                <div class="reading-section">
                    <div class="section-title">Contract Info</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Company Name</span>
                            <span class="info-value" id="rdCompanyName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Branch</span>
                            <span class="info-value" id="rdBranch">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Category</span>
                            <span class="info-value" id="rdCategory">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Invoice #</span>
                            <span class="info-value" id="rdInvoiceNum">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Model</span>
                            <span class="info-value" id="rdModel">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Serial</span>
                            <span class="info-value" id="rdSerial">-</span>
                        </div>
                    </div>
                </div>

                <div class="reading-section">
                    <div class="section-title">Reading Information</div>
                    <div class="reading-dates">
                        <div class="form-field">
                            <label class="field-label">Reading Month</label>
                            <select id="rdMonth" class="field-select" onchange="updateReadingDates()">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="field-label">Year</label>
                            <input type="number" id="rdYear" class="field-input" onchange="updateReadingDates()">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Present Reading Date</label>
                            <input type="date" id="rdPresentDate" class="field-input">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Previous Reading Date</label>
                            <input type="date" id="rdPreviousDate" class="field-input" disabled>
                        </div>
                    </div>
                </div>

                <!-- B&W Reading Section -->
                <div class="reading-section calculation-section">
                    <div class="section-title">B&W Meter Reading</div>
                    <div class="calculation-grid">
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Present Reading</label>
                                <input type="number" id="rdPresentMeter" class="field-input highlight" oninput="calculateBilling()">
                            </div>
                            <div class="form-field">
                                <label class="field-label">Quota</label>
                                <input type="number" id="rdQuota" class="field-input" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Previous Reading</label>
                                <input type="number" id="rdPreviousMeter" class="field-input" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Page Rate</label>
                                <input type="number" id="rdPageRate" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Gross Total Cons.</label>
                                <input type="number" id="rdGrossTotal" class="field-input" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Exceed Page Rate</label>
                                <input type="number" id="rdExceedRate" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field spoilage-field">
                                <input type="checkbox" id="rdSpoilage" checked onchange="calculateBilling()">
                                <label for="rdSpoilage">Spoilage (2%)</label>
                                <input type="number" id="rdSpoilageAmt" class="field-input small" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">VAT (12%)</label>
                                <input type="number" id="rdVat" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Net Consumption</label>
                                <input type="number" id="rdNetConsumption" class="field-input" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Net Amount</label>
                                <input type="number" id="rdNetAmount" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Totals Section -->
                <div class="reading-section totals-section">
                    <div class="totals-grid">
                        <div class="form-field">
                            <label class="field-label">Other Discount(s)</label>
                            <input type="number" id="rdDiscount" class="field-input" step="0.01" value="0" oninput="calculateBilling()">
                        </div>
                        <div class="total-display">
                            <span class="total-label">Amount Due</span>
                            <span class="total-value" id="rdAmountDue">‚Ç±0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Remarks -->
                <div class="reading-section">
                    <div class="form-field">
                        <label class="field-label">Remarks</label>
                        <textarea id="rdRemarks" class="field-textarea" rows="2" placeholder="Optional remarks..."></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="billing-modal-footer">
            <div class="footer-left">
                <button class="btn btn-secondary" onclick="loadPreviousReading()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                    </svg>
                    Load Reading
                </button>
            </div>
            <div class="footer-right">
                <button class="btn btn-secondary" onclick="closeReadingModal()">Cancel</button>
                <button class="btn btn-secondary" onclick="printInvoicePreview()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                    Print Invoice
                </button>
                <button class="btn btn-primary" onclick="confirmBilling()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                        <path d="M22 4L12 14.01l-3-3"/>
                    </svg>
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div class="modal-overlay" id="printModalOverlay"></div>
    <div class="print-modal" id="printModal">
        <div class="print-modal-header">
            <h3>Invoice Print Preview</h3>
            <div class="print-controls">
                <button class="btn btn-secondary btn-sm" onclick="adjustPrintPosition(-1, 0)">‚Üê Left</button>
                <button class="btn btn-secondary btn-sm" onclick="adjustPrintPosition(1, 0)">Right ‚Üí</button>
                <button class="btn btn-secondary btn-sm" onclick="adjustPrintPosition(0, -1)">‚Üë Up</button>
                <button class="btn btn-secondary btn-sm" onclick="adjustPrintPosition(0, 1)">Down ‚Üì</button>
                <button class="btn btn-secondary btn-sm" onclick="resetPrintPosition()">Reset</button>
            </div>
            <button class="modal-close-btn" onclick="closePrintModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="print-modal-body">
            <div class="invoice-preview" id="invoicePreview"></div>
        </div>
        <div class="print-modal-footer">
            <span class="position-info">Position: X=<span id="posX">0</span>mm, Y=<span id="posY">0</span>mm</span>
            <div class="footer-right">
                <button class="btn btn-secondary" onclick="closePrintModal()">Cancel</button>
                <button class="btn btn-primary" onclick="printInvoice()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
                        <rect x="6" y="14" width="12" height="8"/>
                    </svg>
                    Save and Print
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Shared modules -->
    <script src="shared/js/firebase-config.js"></script>
    <script src="shared/js/utils.js"></script>
    <script src="shared/js/auth.js"></script>
    
    <!-- Original billing CSS -->
    <link rel="stylesheet" href="billing/css/billing.css">

    
    <script>
    /**
     * MARGA Billing Module - 3-Panel Workflow
     * Handles meter readings, invoice generation, and billing calculations
     */

    // Global state
    let billingData = {
        contracts: [],
        branches: [],
        companies: [],
        machines: [],
        models: [],
        brands: [],
        categories: [],
        readings: [],
        invoices: []
    };

    let contractsWithInfo = [];
    let readingsForInvoice = []; // Readings without invoice yet
    let pendingInvoices = []; // Invoices pending delivery
    let selectedContract = null;
    let selectedReading = null;
    let readingFilter = 'today';
    let currentInvoice = {
        invoiceNumber: '',
        billingMonth: null,
        billingYear: null,
        presentReading: 0,
        previousReading: 0,
        amountDue: undefined
    };
    let printPosition = { x: 0, y: 0 };

    // Fixed rate category codes
    const FIXED_RATE_CODES = ['RTF', 'RTC', 'MAT', 'STC', 'MAC', 'REF', 'RD', 'PI', 'OTH'];

    /**
     * Initialize Firebase
     */
    function initFirebase() {
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        return firebase.firestore();
    }

    /**
     * Initialize on page load
     */
    document.addEventListener('DOMContentLoaded', async () => {
        initFirebase();
        
        // Check auth
        if (typeof MargaAuth !== 'undefined') {
            MargaAuth.init();
        }
        
        // Set today's date
        const today = new Date();
        document.getElementById('billingDate').value = today.toISOString().split('T')[0];
        
        // Populate year dropdown
        populateYearDropdowns();
        
        // Set default month
        document.getElementById('billingMonth').value = today.getMonth() + 1;
        
        // Load all data
        await loadAllBillingData();
        
        // Render panels
        renderAllPanels();
        
        // Date change listener
        document.getElementById('billingDate').addEventListener('change', () => {
            renderForReadingPanel();
        });
    });

    /**
     * Populate year dropdowns
     */
    function populateYearDropdowns() {
        const currentYear = new Date().getFullYear();
        const years = [currentYear - 1, currentYear, currentYear + 1];
        
        ['billingYear', 'rdYear'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (el.tagName === 'SELECT') {
                    el.innerHTML = years.map(y => 
                        `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`
                    ).join('');
                } else {
                    el.value = currentYear;
                }
            }
        });
    }

    /**
     * Load all billing data from Firebase
     */
    async function loadAllBillingData() {
        try {
            const db = initFirebase();
            showToast('Loading data...');
            
            // Load all collections in parallel
            const [
                contractsSnap,
                branchesSnap,
                companiesSnap,
                machinesSnap,
                modelsSnap,
                brandsSnap,
                categoriesSnap
            ] = await Promise.all([
                db.collection('tbl_contractmain').where('status', '==', 1).get(),
                db.collection('tbl_branchinfo').get(),
                db.collection('tbl_companylist').get(),
                db.collection('tbl_machine').get(),
                db.collection('tbl_model').get(),
                db.collection('tbl_brand').get(),
                db.collection('tbl_particulars').get()
            ]);
            
            billingData.contracts = contractsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            billingData.branches = branchesSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            billingData.companies = companiesSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            billingData.machines = machinesSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            billingData.models = modelsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            billingData.brands = brandsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            billingData.categories = categoriesSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            
            // Load readings
            try {
                const readingsSnap = await db.collection('tbl_readings').get();
                billingData.readings = readingsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            } catch (e) {
                billingData.readings = [];
            }
            
            // Build enriched contracts
            buildContractsWithInfo();
            
            // Load readings that need invoices
            await loadReadingsForInvoice();
            
            // Load pending invoices
            await loadPendingInvoices();
            
            console.log('Loaded:', {
                contracts: billingData.contracts.length,
                readings: billingData.readings.length
            });
            
            showToast('Data loaded!', 'success');
            
        } catch (error) {
            console.error('Error loading data:', error);
            showToast('Error loading data: ' + error.message, 'error');
        }
    }

    /**
     * Build enriched contracts with related info
     */
    function buildContractsWithInfo() {
        const today = new Date();
        const currentMonth = today.getMonth() + 1;
        const currentYear = today.getFullYear();
        
        contractsWithInfo = billingData.contracts.map(contract => {
            const branch = billingData.branches.find(b => b.id == contract.contract_id);
            const company = branch ? billingData.companies.find(c => c.id == branch.company_id) : null;
            const machine = billingData.machines.find(m => m.id == contract.mach_id);
            const model = machine ? billingData.models.find(m => m.id == machine.model_id) : null;
            const brand = machine ? billingData.brands.find(b => b.id == machine.brand_id) : null;
            const category = billingData.categories.find(c => c.id == contract.category_id);
            
            // Extract reading day from reading_date
            let readingDay = 0;
            if (contract.reading_date) {
                if (typeof contract.reading_date === 'string') {
                    const parts = contract.reading_date.split('-');
                    if (parts.length === 3) {
                        readingDay = parseInt(parts[2]) || 0;
                    }
                } else if (contract.reading_date.toDate) {
                    readingDay = contract.reading_date.toDate().getDate();
                } else {
                    readingDay = new Date(contract.reading_date).getDate();
                }
            }
            
            // Get starting meter
            const startingMeter = parseFloat(contract.starting_meter) || parseFloat(contract.b_meter) || 0;
            
            // Check if billed this month
            const billedThisMonth = billingData.readings.some(r => 
                r.contract_id == contract.id && 
                r.billing_month == currentMonth && 
                r.billing_year == currentYear
            );
            
            // Get category code and check if fixed rate
            const categoryCode = category?.particular_code || category?.code || '';
            const isFixedRate = FIXED_RATE_CODES.includes(categoryCode.toUpperCase());
            
            return {
                ...contract,
                branch,
                company,
                machine,
                model,
                brand,
                category,
                categoryCode,
                readingDay,
                startingMeter,
                billedThisMonth,
                isFixedRate,
                monthlyRate: parseFloat(contract.monthly_rate) || 0,
                quota: parseFloat(contract.monthly_quota) || 0,
                pageRate: parseFloat(contract.page_rate) || 0
            };
        });
    }

    /**
     * Load readings that need invoice generation
     */
    async function loadReadingsForInvoice() {
        try {
            const db = initFirebase();
            const snap = await db.collection('tbl_readings')
                .where('invoice_generated', '==', false)
                .get();
            readingsForInvoice = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
        } catch (e) {
            // If field doesn't exist, filter manually
            readingsForInvoice = billingData.readings.filter(r => !r.invoice_generated);
        }
    }

    /**
     * Load pending invoices
     */
    async function loadPendingInvoices() {
        try {
            const db = initFirebase();
            const snap = await db.collection('tbl_invoices')
                .where('status', '==', 'pending_delivery')
                .orderBy('created_at', 'desc')
                .limit(100)
                .get();
            pendingInvoices = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
        } catch (e) {
            // Also check readings with pending status
            pendingInvoices = billingData.readings.filter(r => r.status === 'pending');
        }
    }

    /**
     * Render all panels
     */
    function renderAllPanels() {
        renderForReadingPanel();
        renderForInvoicePanel();
        renderPendingPanel();
        updateStats();
    }

    /**
     * Render Panel 1: For Reading
     */
    function renderForReadingPanel() {
        const dateInput = document.getElementById('billingDate');
        const selectedDate = new Date(dateInput.value);
        const todayDay = selectedDate.getDate();
        const search = (document.getElementById('searchReading')?.value || '').toLowerCase();
        
        // Filter contracts
        let filtered = contractsWithInfo.filter(c => {
            // Skip already billed this month
            // if (c.billedThisMonth) return false;
            
            // Search filter
            if (search) {
                const companyName = c.company?.companyname || '';
                const serial = c.machine?.serial || c.xserial || '';
                if (!companyName.toLowerCase().includes(search) && 
                    !serial.toLowerCase().includes(search)) {
                    return false;
                }
            }
            
            // Day filter
            if (readingFilter === 'today') {
                return c.readingDay === todayDay;
            } else if (readingFilter === 'overdue') {
                return c.readingDay > 0 && c.readingDay < todayDay;
            }
            return true; // 'all'
        });
        
        // Sort: unbilled first, then by reading day
        filtered.sort((a, b) => {
            if (!a.billedThisMonth && b.billedThisMonth) return -1;
            if (a.billedThisMonth && !b.billedThisMonth) return 1;
            return (a.readingDay || 99) - (b.readingDay || 99);
        });
        
        document.getElementById('forReadingCount').textContent = filtered.length;
        const list = document.getElementById('forReadingList');
        
        if (filtered.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M8 12h8"/>
                    </svg>
                    <p>No contracts for reading</p>
                </div>`;
            return;
        }
        
        list.innerHTML = filtered.map(c => {
            const isToday = c.readingDay === todayDay;
            const isOverdue = c.readingDay > 0 && c.readingDay < todayDay;
            const companyName = c.company?.companyname || 'Unknown';
            const modelName = c.model?.modelname || c.machine?.description || 'N/A';
            const serial = c.machine?.serial || c.xserial || 'N/A';
            
            return `
                <div class="contract-item ${c.isFixedRate ? 'fixed-rate' : ''} ${c.billedThisMonth ? 'done' : ''}" 
                     onclick="selectContract(${c.id})" 
                     data-id="${c.id}">
                    <div class="rd-day ${isToday ? 'today' : ''} ${isOverdue ? 'overdue' : ''}">${c.readingDay || '-'}</div>
                    <div class="contract-info">
                        <div class="client-name">${escapeHtml(companyName)}</div>
                        <div class="contract-meta">
                            <span>${escapeHtml(modelName)}</span>
                            <span>${escapeHtml(serial)}</span>
                        </div>
                    </div>
                    <div class="contract-badges">
                        <span class="type-badge ${c.categoryCode.toLowerCase()}">${c.categoryCode || 'N/A'}</span>
                        ${c.isFixedRate ? '<span class="type-badge fixed">FIXED</span>' : ''}
                        <span class="amount-preview">‚Ç±${c.monthlyRate.toLocaleString()}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    /**
     * Render Panel 2: For Invoice
     */
    function renderForInvoicePanel() {
        const search = (document.getElementById('searchForInvoice')?.value || '').toLowerCase();
        
        let filtered = readingsForInvoice.filter(r => {
            if (search) {
                const companyName = r.company_name || '';
                return companyName.toLowerCase().includes(search);
            }
            return true;
        });
        
        document.getElementById('forInvoiceCount').textContent = filtered.length;
        document.getElementById('btnGenerateAll').disabled = filtered.length === 0;
        
        const list = document.getElementById('forInvoiceList');
        
        if (filtered.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <p>No readings pending invoice</p>
                </div>`;
            return;
        }
        
        list.innerHTML = filtered.map(r => {
            const contract = contractsWithInfo.find(c => c.id == r.contract_id);
            const companyName = r.company_name || contract?.company?.companyname || 'Unknown';
            const consumption = r.net_consumption || r.consumption || 0;
            const amount = r.amount_due || r.total_amount || 0;
            
            return `
                <div class="reading-item" onclick="selectReadingForInvoice('${r.docId}')" data-id="${r.docId}">
                    <div class="reading-info">
                        <div class="reading-client">${escapeHtml(companyName)}</div>
                        <div class="reading-meta">Consumption: ${consumption.toLocaleString()}</div>
                    </div>
                    <div class="reading-amount">‚Ç±${amount.toLocaleString()}</div>
                </div>
            `;
        }).join('');
    }

    /**
     * Render Panel 3: Pending Delivery
     */
    function renderPendingPanel() {
        document.getElementById('pendingCount').textContent = pendingInvoices.length;
        document.getElementById('btnAssign').disabled = pendingInvoices.length === 0;
        
        const list = document.getElementById('pendingList');
        
        if (pendingInvoices.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                    </svg>
                    <p>No pending invoices</p>
                </div>`;
            return;
        }
        
        list.innerHTML = pendingInvoices.map(inv => {
            const createdAt = inv.created_at?.toDate?.() || new Date(inv.created_at || Date.now());
            const age = Math.floor((Date.now() - createdAt) / (1000 * 60 * 60 * 24));
            let ageClass = 'new';
            if (age > 14) ageClass = 'old';
            else if (age > 7) ageClass = 'medium';
            
            const invoiceNum = inv.invoice_number || inv.invoice_num || 'N/A';
            const companyName = inv.company_name || 'Unknown';
            const amount = inv.amount_due || inv.total_amount || 0;
            
            return `
                <div class="invoice-item ${age > 14 ? 'old' : ''}" data-id="${inv.docId}">
                    <div class="invoice-info">
                        <div class="invoice-num">${escapeHtml(invoiceNum)}</div>
                        <div class="invoice-client">${escapeHtml(companyName)}</div>
                        <span class="age-badge ${ageClass}">${age}d ago</span>
                    </div>
                    <div class="invoice-amount">‚Ç±${amount.toLocaleString()}</div>
                </div>
            `;
        }).join('');
    }

    /**
     * Update stats bar
     */
    function updateStats() {
        const today = new Date();
        const todayDay = today.getDate();
        const currentMonth = today.getMonth() + 1;
        const currentYear = today.getFullYear();
        
        // Contracts for today's reading
        const forReadingToday = contractsWithInfo.filter(c => c.readingDay === todayDay && !c.billedThisMonth).length;
        
        // Readings pending invoice
        const forInvoice = readingsForInvoice.length;
        
        // Pending delivery
        const pending = pendingInvoices.length;
        
        // Completed today
        const completedToday = billingData.readings.filter(r => {
            const createdAt = r.created_at?.toDate?.() || new Date(r.created_at || 0);
            return createdAt.toDateString() === today.toDateString();
        }).length;
        
        document.getElementById('statToday').textContent = forReadingToday;
        document.getElementById('statForInvoice').textContent = forInvoice;
        document.getElementById('statPending').textContent = pending;
        document.getElementById('statCompleted').textContent = completedToday;
    }

    /**
     * Filter handlers
     */
    function setReadingFilter(filter) {
        readingFilter = filter;
        document.querySelectorAll('#panelForReading .filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        renderForReadingPanel();
    }

    function setQuickFilter(filter) {
        document.querySelectorAll('.stat-item').forEach(s => s.classList.remove('active'));
        event.target.closest('.stat-item')?.classList.add('active');
        
        if (filter === 'today') {
            setReadingFilter('today');
            document.getElementById('panelForReading').scrollIntoView({ behavior: 'smooth' });
        } else if (filter === 'forInvoice') {
            document.getElementById('panelForInvoice').scrollIntoView({ behavior: 'smooth' });
        } else if (filter === 'pending') {
            document.getElementById('panelPending').scrollIntoView({ behavior: 'smooth' });
        }
    }

    /**
     * Select a contract for billing
     */
    function selectContract(contractId) {
        selectedContract = contractsWithInfo.find(c => c.id == contractId);
        if (!selectedContract) {
            showToast('Contract not found', 'error');
            return;
        }
        
        // Highlight selected
        document.querySelectorAll('#forReadingList .contract-item').forEach(el => {
            el.classList.toggle('selected', el.dataset.id == contractId);
        });
        
        document.getElementById('btnEnterReading').disabled = false;
    }

    /**
     * Select a reading for invoice generation
     */
    function selectReadingForInvoice(docId) {
        selectedReading = readingsForInvoice.find(r => r.docId === docId);
        if (!selectedReading) return;
        
        document.querySelectorAll('#forInvoiceList .reading-item').forEach(el => {
            el.classList.toggle('selected', el.dataset.id === docId);
        });
        
        document.getElementById('btnGenerate').disabled = false;
    }

    /**
     * Open billing modal (invoice number entry)
     */
    function openBillingModal() {
        if (!selectedContract) {
            showToast('Please select a contract first', 'error');
            return;
        }
        
        // Warn if already billed
        if (selectedContract.billedThisMonth) {
            if (!confirm('This contract has already been billed this month. Create another invoice?')) {
                return;
            }
        }
        
        // Populate contract info
        const infoDiv = document.getElementById('selectedContractInfo');
        infoDiv.innerHTML = `
            <div class="contract-info-row">
                <span class="contract-info-label">Client</span>
                <span class="contract-info-value">${escapeHtml(selectedContract.company?.companyname || 'Unknown')}</span>
            </div>
            <div class="contract-info-row">
                <span class="contract-info-label">Branch</span>
                <span class="contract-info-value">${escapeHtml(selectedContract.branch?.branchname || 'N/A')}</span>
            </div>
            <div class="contract-info-row">
                <span class="contract-info-label">Model / Serial</span>
                <span class="contract-info-value">${escapeHtml(selectedContract.model?.modelname || 'N/A')} / ${escapeHtml(selectedContract.machine?.serial || 'N/A')}</span>
            </div>
            <div class="contract-info-row">
                <span class="contract-info-label">Category</span>
                <span class="contract-info-value">${escapeHtml(selectedContract.categoryCode)} ${selectedContract.isFixedRate ? '(Fixed Rate)' : '(Per-Page)'}</span>
            </div>
        `;
        
        document.getElementById('invoiceNumber').value = '';
        document.getElementById('invoiceModalOverlay').classList.add('visible');
        document.getElementById('invoiceModal').classList.add('visible');
        document.getElementById('invoiceNumber').focus();
    }

    function closeInvoiceModal() {
        document.getElementById('invoiceModalOverlay').classList.remove('visible');
        document.getElementById('invoiceModal').classList.remove('visible');
    }


    function renderInvoicePreview() {
        const preview = document.getElementById('invoicePreview');
        const c = selectedContract;
        const branch = c.branch;
        const company = c.company;
        
        const billingDate = new Date();
        const formattedDate = billingDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 5);
        const formattedDueDate = dueDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: 'numeric' });
        
        const address = formatBranchAddress(branch);
        
        let description = currentInvoice.isFixedRate 
            ? 'Fixed Monthly Rate' 
            : `Meter Reading: ${currentInvoice.previousReading} to ${currentInvoice.presentReading}`;
        
        preview.innerHTML = `
            <div class="invoice-content" style="transform: translate(${printPosition.x}mm, ${printPosition.y}mm);">
                <div class="inv-row">
                    <div class="inv-client-name">${escapeHtml(company?.companyname || '')} - ${escapeHtml(branch?.branchname || '')}</div>
                    <div class="inv-date">${formattedDate}</div>
                </div>
                <div class="inv-tin">${escapeHtml(company?.company_tin || '')}</div>
                <div class="inv-address">${escapeHtml(address)}</div>
                <div class="inv-model">Printer: ${escapeHtml(c.model?.modelname || '')} | ${escapeHtml(c.machine?.serial || '')}</div>
                <div class="inv-description">${description}</div>
                <div class="inv-total">TOTAL: ${formatCurrency(currentInvoice.amountDue)}</div>
                <div class="inv-due">DUE DATE: ${formattedDueDate}</div>
            </div>
        `;
    }

    function formatBranchAddress(branch) {
        if (!branch) return '';
        const parts = [branch.room, branch.floor, branch.bldg, branch.street, branch.brgy, branch.city_name || ''].filter(Boolean);
        return parts.join(' ');
    }

    function adjustPrintPosition(dx, dy) {
        printPosition.x += dx;
        printPosition.y += dy;
        document.getElementById('posX').textContent = printPosition.x;
        document.getElementById('posY').textContent = printPosition.y;
        renderInvoicePreview();
    }

    function resetPrintPosition() {
        printPosition = { x: 0, y: 0 };
        document.getElementById('posX').textContent = '0';
        document.getElementById('posY').textContent = '0';
        renderInvoicePreview();
    }

    function printInvoice() {
        confirmBilling().then(() => {
            window.print();
            closePrintModal();
        });
    }

    function updateReadingDates() {
        // Placeholder for date logic
    }

    /**
     * Utility functions
     */
    function formatCurrency(amount) {
        return '‚Ç±' + parseFloat(amount || 0).toLocaleString('en-PH', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    </script>
</body>
</html>
