<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARGA - Billing Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared/css/styles.css">
    <link rel="stylesheet" href="shared/css/dashboard.css">
    <style>
        /* 3-Panel Layout - FIXED HEIGHT */
        .billing-panels {
            display: grid;
            grid-template-columns: 1fr 1fr 320px;
            gap: 1rem;
            padding: 0 1rem 1rem;
            height: calc(100vh - 220px);
            max-height: 600px;
            min-height: 450px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            max-height: 100%;
        }
        
        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            background: #f8fafc;
        }
        
        .panel-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1e3a5f;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .panel-title .icon { font-size: 1rem; }
        
        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .badge.blue { background: #dbeafe; color: #1e40af; }
        .badge.orange { background: #fed7aa; color: #9a3412; }
        .badge.green { background: #d1fae5; color: #065f46; }
        .badge.red { background: #fee2e2; color: #dc2626; }
        
        .panel-toolbar {
            padding: 0.5rem 0.75rem;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 0.4rem;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        
        .filter-btn {
            padding: 0.35rem 0.6rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 5px;
            font-size: 0.7rem;
            cursor: pointer;
            color: #64748b;
            font-weight: 500;
            transition: all 0.15s;
        }
        .filter-btn:hover { background: #f1f5f9; }
        .filter-btn.active { 
            background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); 
            color: white; 
            border-color: #1e3a5f; 
        }
        .filter-btn.alert {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .search-input {
            flex: 1;
            min-width: 100px;
            padding: 0.35rem 0.6rem;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 0.75rem;
        }
        .search-input:focus {
            outline: none;
            border-color: #2d5a87;
        }
        
        .panel-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .panel-footer {
            padding: 0.6rem;
            border-top: 1px solid #e5e7eb;
            background: #f8fafc;
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 0.75rem 1rem;
            margin: 0 1rem 0.75rem;
            border-radius: 10px;
            display: none;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(220,38,38,0.3);
        }
        .alert-banner.show { display: flex; }
        .alert-banner .alert-icon { font-size: 1.5rem; }
        .alert-banner .alert-text { flex: 1; }
        .alert-banner .alert-title { font-weight: 700; font-size: 0.9rem; }
        .alert-banner .alert-desc { font-size: 0.8rem; opacity: 0.9; }
        .alert-banner .alert-action {
            padding: 0.5rem 1rem;
            background: white;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* Contract Items - Compact */
        .contract-item {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            display: grid;
            grid-template-columns: 38px 1fr auto;
            gap: 0.6rem;
            align-items: center;
            transition: background 0.15s;
        }
        .contract-item:hover { background: #f8fafc; }
        .contract-item.selected { 
            background: #eff6ff; 
            border-left: 3px solid #2d5a87; 
            padding-left: calc(0.75rem - 3px);
        }
        .contract-item.done { opacity: 0.5; background: #f0fdf4; }
        .contract-item.fixed-rate { border-left: 3px solid #8b5cf6; padding-left: calc(0.75rem - 3px); }
        .contract-item.overdue { background: #fef2f2; }
        
        .rd-day {
            width: 38px; height: 38px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            background: #e0e7ff;
            color: #3730a3;
        }
        .rd-day.today { background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); color: white; }
        .rd-day.overdue { background: #fee2e2; color: #dc2626; }
        
        .contract-info { min-width: 0; }
        .client-name {
            font-weight: 600;
            font-size: 0.8rem;
            color: #1e3a5f;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .contract-meta {
            font-size: 0.7rem;
            color: #64748b;
            display: flex;
            gap: 0.4rem;
            margin-top: 0.15rem;
        }
        
        .contract-badges { display: flex; flex-direction: column; align-items: flex-end; gap: 0.2rem; }
        .type-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .type-badge.rtp { background: #fef3c7; color: #92400e; }
        .type-badge.rtf, .type-badge.mat, .type-badge.ref, .type-badge.oth { background: #dbeafe; color: #1e40af; }
        .type-badge.fixed { background: #f3e8ff; color: #7c3aed; }
        
        .amount-preview { font-size: 0.75rem; font-weight: 600; color: #1e3a5f; }
        
        /* Reading/Invoice Items */
        .reading-item, .invoice-item {
            padding: 0.6rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.15s;
        }
        .reading-item:hover, .invoice-item:hover { background: #f8fafc; }
        .reading-item.selected, .invoice-item.selected { 
            background: #eff6ff; 
            border-left: 3px solid #2d5a87;
            padding-left: calc(0.75rem - 3px);
        }
        
        .reading-info, .invoice-info { flex: 1; min-width: 0; }
        .reading-client, .invoice-num { 
            font-weight: 600; 
            font-size: 0.8rem; 
            color: #1e3a5f; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reading-meta, .invoice-client { font-size: 0.7rem; color: #64748b; margin-top: 0.1rem; }
        .reading-amount, .invoice-amount { font-weight: 600; font-size: 0.85rem; color: #065f46; text-align: right; }
        
        .status-badge {
            font-size: 0.6rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-weight: 600;
            margin-top: 0.2rem;
            display: inline-block;
        }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.assigned { background: #dbeafe; color: #1e40af; }
        .status-badge.delivered { background: #d1fae5; color: #065f46; }
        .status-badge.old { background: #fee2e2; color: #dc2626; }
        
        /* Buttons */
        .btn {
            padding: 0.45rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.75rem;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            flex: 1;
            transition: all 0.15s;
        }
        .btn-primary { background: linear-gradient(135deg, #2d5a87 0%, #1e3a5f 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .btn-secondary { background: white; color: #475569; border: 1px solid #e2e8f0; }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.12); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn svg { width: 14px; height: 14px; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 1.5rem 1rem;
            color: #94a3b8;
        }
        .empty-state svg { width: 36px; height: 36px; margin-bottom: 0.5rem; opacity: 0.4; }
        .empty-state p { font-size: 0.8rem; }
        
        /* Stats Bar - Compact */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin: 0 1rem 0.75rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .stat-item {
            text-align: center;
            padding: 0.5rem;
            border-radius: 8px;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
        }
        .stat-item:hover { background: #f1f5f9; }
        .stat-item.active { border-color: #2d5a87; background: #eff6ff; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #1e3a5f; }
        .stat-label { font-size: 0.65rem; color: #64748b; margin-top: 0.15rem; }
        .stat-item.warning { background: #fef3c7; }
        .stat-item.warning .stat-value { color: #92400e; }
        .stat-item.danger { background: #fee2e2; }
        .stat-item.danger .stat-value { color: #dc2626; }
        .stat-item.success { background: #d1fae5; }
        .stat-item.success .stat-value { color: #065f46; }
        
        /* Spinner */
        .spinner {
            width: 20px; height: 20px;
            border: 2px solid #e5e7eb;
            border-top-color: #2d5a87;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 0.4rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: #1e3a5f;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .toast.show { display: flex; align-items: center; gap: 0.5rem; animation: slideUp 0.3s; }
        .toast.success { background: #16a34a; }
        .toast.error { background: #dc2626; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .billing-panels { grid-template-columns: 1fr 1fr; max-height: none; }
            .billing-panels .panel:last-child { grid-column: span 2; }
        }
        @media (max-width: 768px) {
            .billing-panels { grid-template-columns: 1fr; }
            .billing-panels .panel { min-height: 300px; max-height: 400px; }
            .billing-panels .panel:last-child { grid-column: span 1; }
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="10" fill="url(#logo-gradient)"/>
                    <path d="M10 28V12h4l4 10 4-10h4v16h-3V17l-4 11h-2l-4-11v11H10z" fill="white"/>
                    <defs>
                        <linearGradient id="logo-gradient" x1="0" y1="0" x2="40" y2="40">
                            <stop stop-color="#4299e1"/><stop offset="1" stop-color="#3182ce"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="logo-text">MARGA<span>.</span></span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-title">Main Menu</div>
                <a href="dashboard.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Dashboard
                </a>
                <a href="customers.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                    Customers
                </a>
                <a href="billing.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/></svg>
                    Billing
                </a>
                <a href="#" class="nav-item disabled">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                    Collections
                </a>
                <a href="#" class="nav-item disabled">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>
                    Service
                </a>
            </div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">M</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Loading...</div>
                    <div class="user-role" id="userRole">...</div>
                </div>
                <button class="logout-btn" onclick="MargaAuth?.logout()" title="Logout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="main-header">
            <button class="menu-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
            </button>
            <div class="header-title">
                <h1>Billing Dashboard</h1>
                <p>Meter readings ‚Ä¢ Invoice generation ‚Ä¢ Delivery tracking</p>
            </div>
            <div class="header-actions">
                <input type="date" id="billingDate" class="date-input">
            </div>
        </header>

        <!-- Alert Banner for Overdue -->
        <div class="alert-banner" id="alertBanner">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div class="alert-text">
                <div class="alert-title">Immediate Action Required!</div>
                <div class="alert-desc" id="alertDesc">There are contracts past their reading day this month.</div>
            </div>
            <button class="alert-action" onclick="setReadingFilter('overdue')">View Overdue</button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item active" onclick="setQuickFilter('today')">
                <div class="stat-value" id="statToday">0</div>
                <div class="stat-label">For Reading Today</div>
            </div>
            <div class="stat-item danger" onclick="setQuickFilter('overdue')" id="statOverdueCard">
                <div class="stat-value" id="statOverdue">0</div>
                <div class="stat-label">‚ö†Ô∏è Overdue</div>
            </div>
            <div class="stat-item warning" onclick="setQuickFilter('forInvoice')">
                <div class="stat-value" id="statForInvoice">0</div>
                <div class="stat-label">For Invoice</div>
            </div>
            <div class="stat-item" onclick="setQuickFilter('pending')">
                <div class="stat-value" id="statPending">0</div>
                <div class="stat-label">Pending Delivery</div>
            </div>
        </div>

        <!-- 3-Panel Layout -->
        <div class="billing-panels">
            <!-- Panel 1: For Reading -->
            <div class="panel" id="panelForReading">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üìñ</span> For Reading
                        <span class="badge blue" id="forReadingCount">0</span>
                    </div>
                </div>
                <div class="panel-toolbar">
                    <button class="filter-btn active" data-filter="today" onclick="setReadingFilter('today')">Today</button>
                    <button class="filter-btn" data-filter="overdue" onclick="setReadingFilter('overdue')" id="btnOverdue">Overdue</button>
                    <button class="filter-btn" data-filter="all" onclick="setReadingFilter('all')">All</button>
                    <input type="text" class="search-input" placeholder="Search..." id="searchReading" oninput="renderForReadingPanel()">
                </div>
                <div class="panel-body" id="forReadingList">
                    <div class="empty-state"><div class="spinner"></div><p>Loading...</p></div>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-primary" onclick="openBillingModal()" id="btnEnterReading" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                        Enter Reading
                    </button>
                </div>
            </div>

            <!-- Panel 2: For Invoice (Readings computed but not printed) -->
            <div class="panel" id="panelForInvoice">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üìÑ</span> For Invoice
                        <span class="badge orange" id="forInvoiceCount">0</span>
                    </div>
                </div>
                <div class="panel-toolbar">
                    <input type="text" class="search-input" placeholder="Search..." id="searchForInvoice" oninput="renderForInvoicePanel()" style="flex:1;">
                </div>
                <div class="panel-body" id="forInvoiceList">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        <p>No readings pending invoice</p>
                    </div>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-success" onclick="printSelectedInvoice()" id="btnPrint" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                        Print Invoice
                    </button>
                    <button class="btn btn-secondary" onclick="markAsPrinted()" id="btnMarkPrinted" disabled>Done</button>
                </div>
            </div>

            <!-- Panel 3: Pending Delivery -->
            <div class="panel" id="panelPending">
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="icon">üì¨</span> Pending Delivery
                        <span class="badge green" id="pendingCount">0</span>
                    </div>
                </div>
                <div class="panel-body" id="pendingList">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>
                        <p>No pending deliveries</p>
                    </div>
                </div>
                <div class="panel-footer">
                    <button class="btn btn-secondary" onclick="assignToMessenger()" id="btnAssign" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                        Assign Messenger
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Invoice Number Modal -->
    <div class="modal-overlay" id="invoiceModalOverlay"></div>
    <div class="billing-modal" id="invoiceModal">
        <div class="billing-modal-header">
            <h3>Enter Invoice Details</h3>
            <button class="modal-close-btn" onclick="closeInvoiceModal()">‚úï</button>
        </div>
        <div class="billing-modal-body">
            <div class="selected-contract-info" id="selectedContractInfo"></div>
            <div class="invoice-form">
                <div class="form-field">
                    <label class="field-label">Invoice Number</label>
                    <input type="text" id="invoiceNumber" class="field-input" placeholder="Enter pre-printed invoice number">
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="field-label">Billing Month</label>
                        <select id="billingMonth" class="field-select">
                            <option value="1">January</option><option value="2">February</option><option value="3">March</option>
                            <option value="4">April</option><option value="5">May</option><option value="6">June</option>
                            <option value="7">July</option><option value="8">August</option><option value="9">September</option>
                            <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="field-label">Billing Year</label>
                        <select id="billingYear" class="field-select"></select>
                    </div>
                </div>
            </div>
        </div>
        <div class="billing-modal-footer">
            <button class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
            <button class="btn btn-primary" onclick="proceedToReading()">Proceed ‚Üí</button>
        </div>
    </div>

    <!-- Meter Reading Modal -->
    <div class="modal-overlay" id="readingModalOverlay"></div>
    <div class="billing-modal reading-modal" id="readingModal">
        <div class="billing-modal-header">
            <h3>Billing Details</h3>
            <button class="modal-close-btn" onclick="closeReadingModal()">‚úï</button>
        </div>
        <div class="billing-modal-body">
            <div class="reading-form-layout">
                <div class="reading-section">
                    <div class="section-title">Contract Info</div>
                    <div class="info-grid">
                        <div class="info-item"><span class="info-label">Company</span><span class="info-value" id="rdCompanyName">-</span></div>
                        <div class="info-item"><span class="info-label">Branch</span><span class="info-value" id="rdBranch">-</span></div>
                        <div class="info-item"><span class="info-label">Category</span><span class="info-value" id="rdCategory">-</span></div>
                        <div class="info-item"><span class="info-label">Invoice #</span><span class="info-value" id="rdInvoiceNum">-</span></div>
                        <div class="info-item"><span class="info-label">Model</span><span class="info-value" id="rdModel">-</span></div>
                        <div class="info-item"><span class="info-label">Serial</span><span class="info-value" id="rdSerial">-</span></div>
                    </div>
                </div>
                <div class="reading-section">
                    <div class="section-title">Reading Info</div>
                    <div class="reading-dates">
                        <div class="form-field">
                            <label class="field-label">Month</label>
                            <select id="rdMonth" class="field-select">
                                <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
                                <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                                <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
                                <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label class="field-label">Year</label>
                            <input type="number" id="rdYear" class="field-input">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Present Date</label>
                            <input type="date" id="rdPresentDate" class="field-input">
                        </div>
                        <div class="form-field">
                            <label class="field-label">Previous Date</label>
                            <input type="date" id="rdPreviousDate" class="field-input" disabled>
                        </div>
                    </div>
                </div>
                <div class="reading-section calculation-section">
                    <div class="section-title">B&W Meter Reading</div>
                    <div class="calculation-grid">
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Present Reading</label>
                                <input type="number" id="rdPresentMeter" class="field-input highlight" oninput="calculateBilling()">
                            </div>
                            <div class="form-field">
                                <label class="field-label">Quota</label>
                                <input type="number" id="rdQuota" class="field-input" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Previous Reading</label>
                                <input type="number" id="rdPreviousMeter" class="field-input" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Page Rate</label>
                                <input type="number" id="rdPageRate" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Gross Consumption</label>
                                <input type="number" id="rdGrossTotal" class="field-input" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Exceed Rate</label>
                                <input type="number" id="rdExceedRate" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field spoilage-field">
                                <input type="checkbox" id="rdSpoilage" checked onchange="calculateBilling()">
                                <label for="rdSpoilage">Spoilage (2%)</label>
                                <input type="number" id="rdSpoilageAmt" class="field-input small" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">VAT (12%)</label>
                                <input type="number" id="rdVat" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                        <div class="calc-row">
                            <div class="form-field">
                                <label class="field-label">Net Consumption</label>
                                <input type="number" id="rdNetConsumption" class="field-input" disabled>
                            </div>
                            <div class="form-field">
                                <label class="field-label">Net Amount</label>
                                <input type="number" id="rdNetAmount" class="field-input" step="0.01" disabled>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="reading-section totals-section">
                    <div class="totals-grid">
                        <div class="form-field">
                            <label class="field-label">Discount</label>
                            <input type="number" id="rdDiscount" class="field-input" step="0.01" value="0" oninput="calculateBilling()">
                        </div>
                        <div class="total-display">
                            <span class="total-label">Amount Due</span>
                            <span class="total-value" id="rdAmountDue">‚Ç±0.00</span>
                        </div>
                    </div>
                </div>
                <div class="reading-section">
                    <div class="form-field">
                        <label class="field-label">Remarks</label>
                        <textarea id="rdRemarks" class="field-textarea" rows="2" placeholder="Optional remarks..."></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="billing-modal-footer">
            <button class="btn btn-secondary" onclick="loadPreviousReading()">Load Reading</button>
            <div style="flex:1;"></div>
            <button class="btn btn-secondary" onclick="closeReadingModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmBilling()">‚úì Confirm</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="shared/js/firebase-config.js"></script>
    <script src="shared/js/auth.js"></script>
    <link rel="stylesheet" href="billing/css/billing.css">

    <script>
    /**
     * MARGA Billing Dashboard - 3-Panel Workflow
     * Fixed data loading and overdue alerts
     */

    // Global state
    let billingData = {
        contracts: [],
        branches: {},      // Changed to object for faster lookup
        companies: {},     // Changed to object for faster lookup
        machines: {},      // Changed to object for faster lookup
        models: {},
        brands: {},
        categories: {},
        readings: [],
        invoices: []
    };

    let contractsWithInfo = [];
    let readingsForInvoice = [];
    let pendingDeliveries = [];
    let selectedContract = null;
    let selectedReading = null;
    let readingFilter = 'today';
    let currentInvoice = {};

    // Fixed rate category codes
    const FIXED_RATE_CODES = ['RTF', 'RTC', 'MAT', 'STC', 'MAC', 'REF', 'RD', 'PI', 'OTH'];

    function initFirebase() {
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        return firebase.firestore();
    }

    document.addEventListener('DOMContentLoaded', async () => {
        initFirebase();
        if (typeof MargaAuth !== 'undefined') MargaAuth.init();
        
        const today = new Date();
        document.getElementById('billingDate').value = today.toISOString().split('T')[0];
        populateYearDropdowns();
        document.getElementById('billingMonth').value = today.getMonth() + 1;
        
        await loadAllBillingData();
        renderAllPanels();
        checkOverdueAlert();
        
        document.getElementById('billingDate').addEventListener('change', renderForReadingPanel);
    });

    function populateYearDropdowns() {
        const currentYear = new Date().getFullYear();
        const years = [currentYear - 1, currentYear, currentYear + 1];
        ['billingYear', 'rdYear'].forEach(id => {
            const el = document.getElementById(id);
            if (el && el.tagName === 'SELECT') {
                el.innerHTML = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
            } else if (el) {
                el.value = currentYear;
            }
        });
    }

    async function loadAllBillingData() {
        try {
            const db = initFirebase();
            showToast('Loading data...');
            
            const [contractsSnap, branchesSnap, companiesSnap, machinesSnap, modelsSnap, categoriesSnap] = await Promise.all([
                db.collection('tbl_contractmain').where('status', '==', 1).get(),
                db.collection('tbl_branchinfo').get(),
                db.collection('tbl_companylist').get(),
                db.collection('tbl_machine').get(),
                db.collection('tbl_model').get(),
                db.collection('tbl_particulars').get()
            ]);
            
            // Store contracts as array
            billingData.contracts = contractsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            
            // Store lookup tables as objects keyed by BOTH docId AND id field
            billingData.branches = {};
            branchesSnap.docs.forEach(d => {
                const data = { docId: d.id, ...d.data() };
                billingData.branches[d.id] = data;
                if (data.id) billingData.branches[data.id] = data;
            });
            
            billingData.companies = {};
            companiesSnap.docs.forEach(d => {
                const data = { docId: d.id, ...d.data() };
                billingData.companies[d.id] = data;
                if (data.id) billingData.companies[data.id] = data;
            });
            
            billingData.machines = {};
            machinesSnap.docs.forEach(d => {
                const data = { docId: d.id, ...d.data() };
                billingData.machines[d.id] = data;
                if (data.id) billingData.machines[data.id] = data;
            });
            
            billingData.models = {};
            modelsSnap.docs.forEach(d => {
                const data = { docId: d.id, ...d.data() };
                billingData.models[d.id] = data;
                if (data.id) billingData.models[data.id] = data;
            });
            
            billingData.categories = {};
            categoriesSnap.docs.forEach(d => {
                const data = { docId: d.id, ...d.data() };
                billingData.categories[d.id] = data;
                if (data.id) billingData.categories[data.id] = data;
            });
            
            // Load readings
            try {
                const readingsSnap = await db.collection('tbl_readings').get();
                billingData.readings = readingsSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            } catch (e) { billingData.readings = []; }
            
            // Load invoices
            try {
                const invoicesSnap = await db.collection('tbl_invoices').get();
                billingData.invoices = invoicesSnap.docs.map(d => ({ docId: d.id, ...d.data() }));
            } catch (e) { billingData.invoices = []; }
            
            console.log('Data loaded:', {
                contracts: billingData.contracts.length,
                branches: Object.keys(billingData.branches).length,
                companies: Object.keys(billingData.companies).length,
                machines: Object.keys(billingData.machines).length,
                readings: billingData.readings.length,
                invoices: billingData.invoices.length
            });
            
            buildContractsWithInfo();
            loadReadingsForInvoice();
            loadPendingDeliveries();
            
            showToast('Data loaded!', 'success');
        } catch (error) {
            console.error('Error loading data:', error);
            showToast('Error: ' + error.message, 'error');
        }
    }

    function buildContractsWithInfo() {
        const today = new Date();
        const currentMonth = today.getMonth() + 1;
        const currentYear = today.getFullYear();
        const todayDay = today.getDate();
        
        contractsWithInfo = billingData.contracts.map(contract => {
            // Lookup using contract_id for branch (contract_id = branch_id in the old system)
            const branch = billingData.branches[contract.contract_id] || billingData.branches[contract.branch_id] || null;
            const company = branch ? (billingData.companies[branch.company_id] || null) : null;
            const machine = billingData.machines[contract.mach_id] || billingData.machines[contract.machine_id] || null;
            const model = machine ? (billingData.models[machine.model_id] || null) : null;
            const category = billingData.categories[contract.category_id] || null;
            
            // Extract reading day
            let readingDay = 0;
            if (contract.reading_date) {
                const rdStr = String(contract.reading_date);
                if (rdStr.includes('-')) {
                    const parts = rdStr.split('-');
                    if (parts.length === 3) readingDay = parseInt(parts[2]) || 0;
                } else {
                    readingDay = parseInt(rdStr) || 0;
                }
            }
            
            // Check if billed this month
            const billedThisMonth = billingData.readings.some(r => 
                (r.contract_id == contract.id || r.contract_id == contract.docId) && 
                r.billing_month == currentMonth && 
                r.billing_year == currentYear
            );
            
            // Category info
            const categoryCode = category?.particular_code || category?.code || category?.particular || 'N/A';
            const isFixedRate = FIXED_RATE_CODES.includes(categoryCode.toUpperCase());
            
            // Check if overdue (reading day passed this month and not billed)
            const isOverdue = readingDay > 0 && readingDay < todayDay && !billedThisMonth;
            
            return {
                ...contract,
                branch,
                company,
                machine,
                model,
                category,
                categoryCode: categoryCode.toUpperCase(),
                readingDay,
                billedThisMonth,
                isFixedRate,
                isOverdue,
                monthlyRate: parseFloat(contract.monthly_rate) || 0,
                quota: parseFloat(contract.monthly_quota) || 0,
                pageRate: parseFloat(contract.page_rate) || 0,
                startingMeter: parseFloat(contract.starting_meter) || parseFloat(contract.b_meter) || 0
            };
        });
        
        console.log('Sample enriched contract:', contractsWithInfo[0]);
    }

    function loadReadingsForInvoice() {
        // Readings that are computed (status = 'pending') but not yet printed (printed = false or null)
        readingsForInvoice = billingData.readings.filter(r => 
            r.status === 'pending' && !r.printed
        );
        console.log('Readings for invoice:', readingsForInvoice.length);
    }

    function loadPendingDeliveries() {
        // Combine readings with status 'printed' or invoices with various delivery statuses
        pendingDeliveries = [];
        
        // From readings - printed but not delivered
        billingData.readings.forEach(r => {
            if (r.printed && r.status !== 'delivered' && r.status !== 'paid') {
                pendingDeliveries.push({
                    ...r,
                    type: 'reading',
                    deliveryStatus: r.assigned_to ? 'assigned' : 'pending'
                });
            }
        });
        
        // From invoices collection
        billingData.invoices.forEach(inv => {
            if (inv.status === 'pending_delivery' || inv.status === 'assigned' || inv.status === 'for_delivery') {
                pendingDeliveries.push({
                    ...inv,
                    type: 'invoice',
                    deliveryStatus: inv.assigned_to ? 'assigned' : 'pending'
                });
            }
        });
        
        console.log('Pending deliveries:', pendingDeliveries.length);
    }

    function checkOverdueAlert() {
        const overdueCount = contractsWithInfo.filter(c => c.isOverdue).length;
        const alertBanner = document.getElementById('alertBanner');
        const btnOverdue = document.getElementById('btnOverdue');
        
        if (overdueCount > 0) {
            alertBanner.classList.add('show');
            document.getElementById('alertDesc').textContent = 
                `${overdueCount} contract${overdueCount > 1 ? 's are' : ' is'} past their reading day this month and need immediate billing!`;
            btnOverdue.classList.add('alert');
            btnOverdue.textContent = `Overdue (${overdueCount})`;
        } else {
            alertBanner.classList.remove('show');
            btnOverdue.classList.remove('alert');
            btnOverdue.textContent = 'Overdue';
        }
    }

    function renderAllPanels() {
        renderForReadingPanel();
        renderForInvoicePanel();
        renderPendingPanel();
        updateStats();
    }


    function renderForReadingPanel() {
        const dateInput = document.getElementById('billingDate');
        const selectedDate = new Date(dateInput.value);
        const todayDay = selectedDate.getDate();
        const search = (document.getElementById('searchReading')?.value || '').toLowerCase();
        
        let filtered = contractsWithInfo.filter(c => {
            // Search filter
            if (search) {
                const companyName = c.company?.companyname || '';
                const serial = c.machine?.serial || c.xserial || '';
                const branchName = c.branch?.branchname || '';
                if (!companyName.toLowerCase().includes(search) && 
                    !serial.toLowerCase().includes(search) &&
                    !branchName.toLowerCase().includes(search)) {
                    return false;
                }
            }
            
            // Day filter
            if (readingFilter === 'today') {
                return c.readingDay === todayDay;
            } else if (readingFilter === 'overdue') {
                return c.isOverdue;
            }
            return true;
        });
        
        // Sort: overdue first, then unbilled, then by reading day
        filtered.sort((a, b) => {
            if (a.isOverdue && !b.isOverdue) return -1;
            if (!a.isOverdue && b.isOverdue) return 1;
            if (!a.billedThisMonth && b.billedThisMonth) return -1;
            if (a.billedThisMonth && !b.billedThisMonth) return 1;
            return (a.readingDay || 99) - (b.readingDay || 99);
        });
        
        document.getElementById('forReadingCount').textContent = filtered.length;
        const list = document.getElementById('forReadingList');
        
        if (filtered.length === 0) {
            list.innerHTML = `<div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>
                <p>No contracts found</p>
            </div>`;
            return;
        }
        
        list.innerHTML = filtered.map(c => {
            const isToday = c.readingDay === todayDay;
            const companyName = c.company?.companyname || 'Unknown Company';
            const branchName = c.branch?.branchname || '';
            const modelName = c.model?.modelname || c.machine?.description || 'N/A';
            const serial = c.machine?.serial || c.xserial || 'N/A';
            
            let itemClass = '';
            if (c.isOverdue) itemClass = 'overdue';
            else if (c.billedThisMonth) itemClass = 'done';
            else if (c.isFixedRate) itemClass = 'fixed-rate';
            
            return `
                <div class="contract-item ${itemClass}" onclick="selectContract('${c.docId || c.id}')" data-id="${c.docId || c.id}">
                    <div class="rd-day ${isToday ? 'today' : ''} ${c.isOverdue ? 'overdue' : ''}">${c.readingDay || '-'}</div>
                    <div class="contract-info">
                        <div class="client-name">${escapeHtml(companyName)}</div>
                        <div class="contract-meta">
                            <span>${escapeHtml(branchName || modelName)}</span>
                            <span>${escapeHtml(serial)}</span>
                        </div>
                    </div>
                    <div class="contract-badges">
                        <span class="type-badge ${c.categoryCode.toLowerCase()}">${c.categoryCode}</span>
                        ${c.isFixedRate ? '<span class="type-badge fixed">FIXED</span>' : ''}
                        <span class="amount-preview">‚Ç±${c.monthlyRate.toLocaleString()}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderForInvoicePanel() {
        const search = (document.getElementById('searchForInvoice')?.value || '').toLowerCase();
        
        let filtered = readingsForInvoice.filter(r => {
            if (search) {
                const name = r.company_name || '';
                return name.toLowerCase().includes(search);
            }
            return true;
        });
        
        document.getElementById('forInvoiceCount').textContent = filtered.length;
        document.getElementById('btnPrint').disabled = true;
        document.getElementById('btnMarkPrinted').disabled = filtered.length === 0;
        
        const list = document.getElementById('forInvoiceList');
        
        if (filtered.length === 0) {
            list.innerHTML = `<div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                <p>No readings pending print</p>
            </div>`;
            return;
        }
        
        list.innerHTML = filtered.map(r => {
            const contract = contractsWithInfo.find(c => c.id == r.contract_id || c.docId == r.contract_id);
            const companyName = r.company_name || contract?.company?.companyname || 'Unknown';
            const invoiceNum = r.invoice_number || 'Pending';
            const amount = r.amount_due || 0;
            
            return `
                <div class="reading-item" onclick="selectReadingForPrint('${r.docId}')" data-id="${r.docId}">
                    <div class="reading-info">
                        <div class="reading-client">${escapeHtml(companyName)}</div>
                        <div class="reading-meta">Invoice: ${escapeHtml(invoiceNum)} | Cons: ${r.net_consumption || 0}</div>
                    </div>
                    <div class="reading-amount">‚Ç±${amount.toLocaleString()}</div>
                </div>
            `;
        }).join('');
    }

    function renderPendingPanel() {
        document.getElementById('pendingCount').textContent = pendingDeliveries.length;
        document.getElementById('btnAssign').disabled = pendingDeliveries.length === 0;
        
        const list = document.getElementById('pendingList');
        
        if (pendingDeliveries.length === 0) {
            list.innerHTML = `<div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>
                <p>No pending deliveries</p>
            </div>`;
            return;
        }
        
        list.innerHTML = pendingDeliveries.map(inv => {
            const createdAt = inv.created_at?.toDate?.() || new Date(inv.created_at || Date.now());
            const age = Math.floor((Date.now() - createdAt) / (1000 * 60 * 60 * 24));
            let statusClass = inv.deliveryStatus === 'assigned' ? 'assigned' : (age > 7 ? 'old' : 'pending');
            
            const invoiceNum = inv.invoice_number || inv.invoice_num || 'N/A';
            const companyName = inv.company_name || 'Unknown';
            const amount = inv.amount_due || inv.total_amount || 0;
            const assignedTo = inv.assigned_to || '';
            
            return `
                <div class="invoice-item" data-id="${inv.docId}">
                    <div class="invoice-info">
                        <div class="invoice-num">${escapeHtml(invoiceNum)}</div>
                        <div class="invoice-client">${escapeHtml(companyName)}</div>
                        <span class="status-badge ${statusClass}">${assignedTo ? `üì¶ ${assignedTo}` : `${age}d ago`}</span>
                    </div>
                    <div class="invoice-amount">‚Ç±${amount.toLocaleString()}</div>
                </div>
            `;
        }).join('');
    }

    function updateStats() {
        const today = new Date();
        const todayDay = today.getDate();
        
        const forToday = contractsWithInfo.filter(c => c.readingDay === todayDay && !c.billedThisMonth).length;
        const overdue = contractsWithInfo.filter(c => c.isOverdue).length;
        const forInvoice = readingsForInvoice.length;
        const pending = pendingDeliveries.length;
        
        document.getElementById('statToday').textContent = forToday;
        document.getElementById('statOverdue').textContent = overdue;
        document.getElementById('statForInvoice').textContent = forInvoice;
        document.getElementById('statPending').textContent = pending;
        
        // Hide/show overdue card
        const overdueCard = document.getElementById('statOverdueCard');
        if (overdue === 0) {
            overdueCard.classList.remove('danger');
            overdueCard.classList.add('success');
        }
    }

    function setReadingFilter(filter) {
        readingFilter = filter;
        document.querySelectorAll('#panelForReading .filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filter);
            if (btn.dataset.filter === 'overdue' && btn.classList.contains('alert')) {
                // Keep alert class
            }
        });
        renderForReadingPanel();
    }

    function setQuickFilter(filter) {
        document.querySelectorAll('.stat-item').forEach(s => s.classList.remove('active'));
        event?.target?.closest('.stat-item')?.classList.add('active');
        
        if (filter === 'today') setReadingFilter('today');
        else if (filter === 'overdue') setReadingFilter('overdue');
        else if (filter === 'forInvoice') document.getElementById('panelForInvoice').scrollIntoView({ behavior: 'smooth' });
        else if (filter === 'pending') document.getElementById('panelPending').scrollIntoView({ behavior: 'smooth' });
    }

    function selectContract(contractId) {
        selectedContract = contractsWithInfo.find(c => c.docId == contractId || c.id == contractId);
        if (!selectedContract) {
            showToast('Contract not found', 'error');
            return;
        }
        
        document.querySelectorAll('#forReadingList .contract-item').forEach(el => {
            el.classList.toggle('selected', el.dataset.id == contractId);
        });
        
        document.getElementById('btnEnterReading').disabled = false;
    }

    function selectReadingForPrint(docId) {
        selectedReading = readingsForInvoice.find(r => r.docId === docId);
        
        document.querySelectorAll('#forInvoiceList .reading-item').forEach(el => {
            el.classList.toggle('selected', el.dataset.id === docId);
        });
        
        document.getElementById('btnPrint').disabled = !selectedReading;
    }

    function openBillingModal() {
        if (!selectedContract) {
            showToast('Please select a contract first', 'error');
            return;
        }
        
        if (selectedContract.billedThisMonth) {
            if (!confirm('This contract was already billed this month. Create another?')) return;
        }
        
        const c = selectedContract;
        document.getElementById('selectedContractInfo').innerHTML = `
            <div style="padding:0.75rem;background:#f8fafc;border-radius:8px;margin-bottom:1rem;">
                <div style="font-weight:700;color:#1e3a5f;">${escapeHtml(c.company?.companyname || 'Unknown')}</div>
                <div style="font-size:0.8rem;color:#64748b;">${escapeHtml(c.branch?.branchname || '')} | ${c.categoryCode} | ‚Ç±${c.monthlyRate.toLocaleString()}/mo</div>
                <div style="font-size:0.75rem;color:#94a3b8;">${escapeHtml(c.model?.modelname || '')} | ${escapeHtml(c.machine?.serial || '')}</div>
            </div>
        `;
        
        document.getElementById('invoiceNumber').value = '';
        document.getElementById('invoiceModalOverlay').classList.add('visible');
        document.getElementById('invoiceModal').classList.add('visible');
        document.getElementById('invoiceNumber').focus();
    }

    function closeInvoiceModal() {
        document.getElementById('invoiceModalOverlay').classList.remove('visible');
        document.getElementById('invoiceModal').classList.remove('visible');
    }

    function proceedToReading() {
        const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
        if (!invoiceNumber) {
            showToast('Please enter invoice number', 'error');
            return;
        }
        
        currentInvoice = {
            invoiceNumber,
            billingMonth: parseInt(document.getElementById('billingMonth').value),
            billingYear: parseInt(document.getElementById('billingYear').value)
        };
        
        closeInvoiceModal();
        openReadingModal();
    }


    async function openReadingModal() {
        const c = selectedContract;
        
        document.getElementById('rdCompanyName').textContent = c.company?.companyname || 'N/A';
        document.getElementById('rdBranch').textContent = c.branch?.branchname || 'N/A';
        document.getElementById('rdCategory').textContent = c.categoryCode + (c.isFixedRate ? ' (Fixed)' : '');
        document.getElementById('rdInvoiceNum').textContent = currentInvoice.invoiceNumber;
        document.getElementById('rdModel').textContent = c.model?.modelname || 'N/A';
        document.getElementById('rdSerial').textContent = c.machine?.serial || c.xserial || 'N/A';
        
        document.getElementById('rdMonth').value = currentInvoice.billingMonth;
        document.getElementById('rdYear').value = currentInvoice.billingYear;
        document.getElementById('rdPresentDate').value = new Date().toISOString().split('T')[0];
        
        document.getElementById('rdQuota').value = c.quota || 0;
        document.getElementById('rdPageRate').value = c.pageRate || 0;
        document.getElementById('rdExceedRate').value = c.page_rate_xtra || c.pageRate || 0;
        
        if (c.isFixedRate) {
            document.getElementById('rdPresentMeter').disabled = true;
            document.getElementById('rdPresentMeter').value = 'N/A';
            calculateFixedRateBilling();
        } else {
            document.getElementById('rdPresentMeter').disabled = false;
            document.getElementById('rdPresentMeter').value = '';
        }
        
        document.getElementById('rdGrossTotal').value = '';
        document.getElementById('rdSpoilageAmt').value = '';
        document.getElementById('rdNetConsumption').value = '';
        document.getElementById('rdVat').value = '';
        document.getElementById('rdNetAmount').value = '';
        document.getElementById('rdDiscount').value = '0';
        document.getElementById('rdAmountDue').textContent = '‚Ç±0.00';
        document.getElementById('rdRemarks').value = '';
        document.getElementById('rdPreviousMeter').value = c.startingMeter || 0;
        
        document.getElementById('readingModalOverlay').classList.add('visible');
        document.getElementById('readingModal').classList.add('visible');
        
        await fetchPreviousReading();
        if (!c.isFixedRate) document.getElementById('rdPresentMeter').focus();
    }

    function closeReadingModal() {
        document.getElementById('readingModalOverlay').classList.remove('visible');
        document.getElementById('readingModal').classList.remove('visible');
    }

    async function fetchPreviousReading() {
        const db = initFirebase();
        const contractId = selectedContract.id || selectedContract.docId;
        const machineId = selectedContract.mach_id || selectedContract.machine_id;
        
        // Check tbl_readings first
        try {
            const snap = await db.collection('tbl_readings')
                .where('contract_id', '==', contractId)
                .orderBy('created_at', 'desc')
                .limit(1)
                .get();
            
            if (!snap.empty) {
                const r = snap.docs[0].data();
                document.getElementById('rdPreviousMeter').value = r.present_reading || 0;
                if (r.present_date) document.getElementById('rdPreviousDate').value = r.present_date;
                return;
            }
        } catch (e) { console.log('Readings query:', e.message); }
        
        // Check tbl_machinereading
        try {
            let snap = await db.collection('tbl_machinereading')
                .where('current_contract', '==', parseInt(contractId))
                .orderBy('date_red', 'desc')
                .limit(1)
                .get();
            
            if (snap.empty && machineId) {
                snap = await db.collection('tbl_machinereading')
                    .where('machine_id', '==', parseInt(machineId))
                    .orderBy('date_red', 'desc')
                    .limit(1)
                    .get();
            }
            
            if (!snap.empty) {
                const r = snap.docs[0].data();
                document.getElementById('rdPreviousMeter').value = r.meter_reading || 0;
                if (r.date_red) document.getElementById('rdPreviousDate').value = r.date_red;
                return;
            }
        } catch (e) { console.log('Machine readings query:', e.message); }
        
        // Fallback
        document.getElementById('rdPreviousMeter').value = selectedContract.startingMeter || 0;
    }

    async function loadPreviousReading() {
        showToast('Loading previous reading...');
        await fetchPreviousReading();
        showToast('Loaded!', 'success');
    }

    function calculateBilling() {
        const present = parseFloat(document.getElementById('rdPresentMeter').value) || 0;
        const previous = parseFloat(document.getElementById('rdPreviousMeter').value) || 0;
        const quota = parseFloat(document.getElementById('rdQuota').value) || 0;
        const pageRate = parseFloat(document.getElementById('rdPageRate').value) || 0;
        const exceedRate = parseFloat(document.getElementById('rdExceedRate').value) || pageRate;
        const discount = parseFloat(document.getElementById('rdDiscount').value) || 0;
        const applySpoilage = document.getElementById('rdSpoilage').checked;
        const isVat = selectedContract.withvat == 1;
        
        const gross = Math.max(0, present - previous);
        const spoilage = applySpoilage && gross > 0 ? Math.round(gross * 0.02) : 0;
        const net = gross - spoilage;
        
        let amount = 0;
        if (quota > 0) {
            amount = net <= quota ? quota * pageRate : (quota * pageRate) + ((net - quota) * exceedRate);
        } else {
            amount = net * pageRate;
        }
        
        let vat = 0, netAmt = amount;
        if (isVat) { netAmt = amount / 1.12; vat = amount - netAmt; }
        
        document.getElementById('rdGrossTotal').value = gross;
        document.getElementById('rdSpoilageAmt').value = spoilage;
        document.getElementById('rdNetConsumption').value = net;
        document.getElementById('rdVat').value = vat.toFixed(2);
        document.getElementById('rdNetAmount').value = netAmt.toFixed(2);
        document.getElementById('rdAmountDue').textContent = '‚Ç±' + (amount - discount).toLocaleString(undefined, {minimumFractionDigits: 2});
        
        currentInvoice = { ...currentInvoice, presentReading: present, previousReading: previous, grossConsumption: gross, spoilage, netConsumption: net, vatAmount: vat, netAmount: netAmt, discount, amountDue: amount - discount, isVatInclusive: isVat, isFixedRate: false };
    }

    function calculateFixedRateBilling() {
        const rate = selectedContract.monthlyRate || 0;
        const discount = parseFloat(document.getElementById('rdDiscount').value) || 0;
        const isVat = selectedContract.withvat == 1;
        
        let vat = 0, netAmt = rate;
        if (isVat) { netAmt = rate / 1.12; vat = rate - netAmt; }
        
        document.getElementById('rdVat').value = vat.toFixed(2);
        document.getElementById('rdNetAmount').value = netAmt.toFixed(2);
        document.getElementById('rdAmountDue').textContent = '‚Ç±' + (rate - discount).toLocaleString(undefined, {minimumFractionDigits: 2});
        
        currentInvoice = { ...currentInvoice, presentReading: 0, previousReading: 0, grossConsumption: 0, spoilage: 0, netConsumption: 0, vatAmount: vat, netAmount: netAmt, discount, amountDue: rate - discount, isVatInclusive: isVat, isFixedRate: true };
    }

    async function confirmBilling() {
        if (!currentInvoice.amountDue && currentInvoice.amountDue !== 0) {
            showToast('Please complete billing calculation', 'error');
            return;
        }
        
        try {
            const db = firebase.firestore();
            const c = selectedContract;
            
            const data = {
                contract_id: c.id || c.docId,
                company_name: c.company?.companyname || '',
                branch_name: c.branch?.branchname || '',
                invoice_number: currentInvoice.invoiceNumber,
                billing_month: currentInvoice.billingMonth,
                billing_year: currentInvoice.billingYear,
                present_reading: currentInvoice.presentReading,
                previous_reading: currentInvoice.previousReading,
                gross_consumption: currentInvoice.grossConsumption,
                spoilage: currentInvoice.spoilage,
                net_consumption: currentInvoice.netConsumption,
                vat_amount: currentInvoice.vatAmount,
                net_amount: currentInvoice.netAmount,
                discount: currentInvoice.discount,
                amount_due: currentInvoice.amountDue,
                is_vat_inclusive: currentInvoice.isVatInclusive,
                is_fixed_rate: currentInvoice.isFixedRate,
                present_date: document.getElementById('rdPresentDate').value,
                previous_date: document.getElementById('rdPreviousDate').value,
                remarks: document.getElementById('rdRemarks').value,
                created_by: firebase.auth().currentUser?.email || 'billing_staff',
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending',
                printed: false
            };
            
            await db.collection('tbl_readings').add(data);
            showToast('Billing saved!', 'success');
            closeReadingModal();
            
            selectedContract = null;
            document.getElementById('btnEnterReading').disabled = true;
            
            await loadAllBillingData();
            renderAllPanels();
            checkOverdueAlert();
            
        } catch (e) {
            console.error('Error:', e);
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function printSelectedInvoice() {
        if (!selectedReading) return;
        showToast('Opening print preview...');
        // TODO: Implement print preview
        window.print();
    }

    async function markAsPrinted() {
        if (readingsForInvoice.length === 0) return;
        
        if (!confirm(`Mark ${readingsForInvoice.length} reading(s) as printed?`)) return;
        
        const db = firebase.firestore();
        const batch = db.batch();
        
        readingsForInvoice.forEach(r => {
            batch.update(db.collection('tbl_readings').doc(r.docId), { printed: true, status: 'printed' });
        });
        
        await batch.commit();
        showToast('Marked as printed!', 'success');
        
        await loadAllBillingData();
        renderAllPanels();
    }

    function assignToMessenger() {
        showToast('Messenger assignment coming soon!');
    }

    // Utilities
    function formatCurrency(amt) {
        return '‚Ç±' + parseFloat(amt || 0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function showToast(msg, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    </script>
</body>
</html>
