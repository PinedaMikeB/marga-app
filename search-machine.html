<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search Machine bmeter for 71075</title>
    <style>
        body { font-family: system-ui; padding: 2rem; background: #f5f5f5; }
        pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 500px; }
        .found { background: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 4px; margin: 0.5rem 0; display: inline-block; }
        .not-found { background: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 4px; }
        h2 { color: #1e3a5f; margin-top: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f1f5f9; font-weight: 600; }
        .highlight { background: #fef3c7; }
    </style>
</head>
<body>
    <h1>üîç Search tbl_machine for bmeter = 71075</h1>
    
    <div id="output">
        <p>Searching...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shared/js/firebase-config.js"></script>
    <script>
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        async function search() {
            const output = document.getElementById('output');
            let html = '';
            
            // Load all data
            const [machinesSnap, contractsSnap, branchesSnap, companiesSnap] = await Promise.all([
                db.collection('tbl_machine').get(),
                db.collection('tbl_contractmain').get(),
                db.collection('tbl_branchinfo').get(),
                db.collection('tbl_companylist').get()
            ]);
            
            const machines = machinesSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            const contracts = contractsSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            const branches = branchesSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            const companies = companiesSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            
            // Show machine fields first
            html += '<div class="card">';
            html += '<h2>Step 1: tbl_machine fields</h2>';
            const allFields = new Set();
            machines.slice(0, 50).forEach(m => Object.keys(m).forEach(k => allFields.add(k)));
            const fields = Array.from(allFields).sort();
            const meterFields = fields.filter(f => f.toLowerCase().includes('meter') || f.toLowerCase().includes('reading'));
            html += `<p><strong>Meter-related fields:</strong> ${meterFields.join(', ')}</p>`;
            html += `<p>All fields: ${fields.join(', ')}</p>`;
            html += '</div>';
            
            // Search for 71075 in machines
            html += '<div class="card">';
            html += '<h2>Step 2: Search machines for 71075</h2>';
            
            const machinesWith71075 = machines.filter(m => {
                return Object.entries(m).some(([key, val]) => {
                    if (val == 71075 || val == '71075') return true;
                    if (typeof val === 'string' && val.includes('71075')) return true;
                    return false;
                });
            });
            
            if (machinesWith71075.length > 0) {
                html += `<p class="found">‚úÖ Found ${machinesWith71075.length} machines with 71075</p>`;
                machinesWith71075.forEach(m => {
                    // Find which contract uses this machine
                    const contract = contracts.find(c => c.mach_id == m.id);
                    let companyName = 'Unknown';
                    if (contract) {
                        const branch = branches.find(b => b.id == contract.contract_id);
                        if (branch) {
                            const company = companies.find(c => c.id == branch.company_id);
                            companyName = company?.companyname || 'Unknown';
                        }
                    }
                    
                    html += `<h4>Machine ID: ${m.id}</h4>`;
                    html += `<p>Used by: <strong>${companyName}</strong></p>`;
                    html += `<p>bmeter: <strong>${m.bmeter}</strong></p>`;
                    html += `<pre>${JSON.stringify(m, null, 2)}</pre>`;
                });
            } else {
                html += `<p class="not-found">‚ùå No machines found with 71075 in any field</p>`;
            }
            html += '</div>';
            
            // Find Infinity Internet's machine
            html += '<div class="card">';
            html += '<h2>Step 3: Find Infinity Internet and Printing Services machine</h2>';
            
            const infinityCompany = companies.find(c => 
                c.companyname && c.companyname.toLowerCase().includes('infinity internet')
            );
            
            if (infinityCompany) {
                html += `<p>Company: ${infinityCompany.companyname} (ID: ${infinityCompany.id})</p>`;
                
                const infinityBranches = branches.filter(b => b.company_id == infinityCompany.id);
                const branchIds = infinityBranches.map(b => b.id);
                const infinityContracts = contracts.filter(c => branchIds.includes(c.contract_id));
                
                html += `<p>Contracts: ${infinityContracts.length}</p>`;
                
                infinityContracts.forEach(c => {
                    const machine = machines.find(m => m.id == c.mach_id);
                    html += `<h4>Contract ${c.id} ‚Üí Machine ${c.mach_id}</h4>`;
                    if (machine) {
                        html += `<p>Machine bmeter: <strong>${machine.bmeter || 'N/A'}</strong></p>`;
                        html += `<p>Machine serial: ${machine.serial}</p>`;
                        html += `<pre>${JSON.stringify(machine, null, 2)}</pre>`;
                    } else {
                        html += `<p class="not-found">Machine not found</p>`;
                    }
                });
            }
            html += '</div>';
            
            // Show sample machines with bmeter values
            html += '<div class="card">';
            html += '<h2>Step 4: Sample machines with bmeter values</h2>';
            
            const machinesWithBmeter = machines.filter(m => m.bmeter && m.bmeter != '0' && m.bmeter != 0).slice(0, 20);
            html += '<table>';
            html += '<tr><th>Machine ID</th><th>bmeter</th><th>Serial</th><th>Description</th></tr>';
            machinesWithBmeter.forEach(m => {
                html += `<tr>
                    <td>${m.id}</td>
                    <td><strong>${m.bmeter}</strong></td>
                    <td>${m.serial || '-'}</td>
                    <td>${m.description || '-'}</td>
                </tr>`;
            });
            html += '</table>';
            html += '</div>';
            
            output.innerHTML = html;
        }
        
        search();
    </script>
</body>
</html>
