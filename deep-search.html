<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deep Search for Billing Tables</title>
    <style>
        body { font-family: system-ui; padding: 2rem; background: #f5f5f5; }
        pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 400px; font-size: 0.85rem; }
        .found { background: #22c55e; color: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; }
        .not-found { background: #ef4444; color: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; }
        .warn { background: #f59e0b; color: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; }
        h2 { color: #1e3a5f; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 0.5rem; text-align: left; border: 1px solid #e5e7eb; font-size: 0.85rem; }
        th { background: #f8fafc; }
        .highlight { background: #fef3c7; }
    </style>
</head>
<body>
    <h1>üîç Deep Search for Billing/Invoice Tables</h1>
    <p>Looking for tables that store meter reading history...</p>
    
    <div id="output">
        <p>Searching...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shared/js/firebase-config.js"></script>
    <script>
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Extended list of possible table names
        const allPossibleTables = [
            // Invoice tables
            'tbl_invoice', 'tbl_invoices', 'tbl_inv', 'tbl_invdetails', 'tbl_invoicedetail',
            'tbl_invoice_detail', 'tbl_invoice_details', 'tbl_invoicelist', 'tbl_invoice_list',
            'tbl_invlist', 'tbl_inv_list', 'tbl_invheader', 'tbl_inv_header',
            
            // Billing tables
            'tbl_billing', 'tbl_billings', 'tbl_bill', 'tbl_bills', 'tbl_billdetail',
            'tbl_billing_detail', 'tbl_billing_details', 'tbl_billinfo', 'tbl_bill_info',
            'tbl_billinginfo', 'tbl_billing_info', 'tbl_billheader', 'tbl_bill_header',
            
            // Reading/Meter tables
            'tbl_reading', 'tbl_readings', 'tbl_meterreading', 'tbl_meter_reading',
            'tbl_meter', 'tbl_meters', 'tbl_readinghistory', 'tbl_reading_history',
            'tbl_meterhistory', 'tbl_meter_history', 'tbl_consumption',
            
            // Transaction tables
            'tbl_transaction', 'tbl_transactions', 'tbl_trans', 'tbl_transdetail',
            'tbl_transactiondetail', 'tbl_transaction_detail',
            
            // Collection/Payment tables
            'tbl_collection', 'tbl_collections', 'tbl_payment', 'tbl_payments',
            'tbl_ar', 'tbl_receivable', 'tbl_receivables', 'tbl_ardetail',
            
            // History tables
            'tbl_history', 'tbl_contracthistory', 'tbl_contract_history',
            'tbl_machhistory', 'tbl_mach_history', 'tbl_machinehistory',
            
            // Sales tables
            'tbl_sales', 'tbl_salesdetail', 'tbl_sales_detail',
            
            // Already known to exist
            'tbl_companylist', 'tbl_branchinfo', 'tbl_contractmain', 'tbl_machine',
            'tbl_model', 'tbl_brand', 'tbl_billinfo', 'tbl_area', 'tbl_city',
            'tbl_particulars', 'tbl_contractstatus', 'tbl_newmachinestatus',
            
            // Other possible names
            'tbl_dr', 'tbl_delivery', 'tbl_deliveryreceipt', 'tbl_delivery_receipt',
            'tbl_service', 'tbl_servicehistory', 'tbl_pullout', 'tbl_schedule',
            'invoice', 'invoices', 'billing', 'readings', 'transactions'
        ];

        async function search() {
            const output = document.getElementById('output');
            let html = '<div class="card">';
            html += '<h2>All Firebase Collections Found</h2>';
            html += '<table><tr><th>Collection</th><th>Sample Count</th><th>Has Reading Fields?</th><th>Sample Fields</th></tr>';
            
            const foundCollections = [];
            const readingCollections = [];
            
            for (const coll of allPossibleTables) {
                try {
                    const snap = await db.collection(coll).limit(3).get();
                    if (!snap.empty) {
                        foundCollections.push(coll);
                        
                        // Get all fields from samples
                        const allFields = new Set();
                        snap.docs.forEach(d => Object.keys(d.data()).forEach(k => allFields.add(k)));
                        const fields = Array.from(allFields);
                        
                        // Check for reading-related fields
                        const hasReadingFields = fields.some(f => {
                            const lower = f.toLowerCase();
                            return lower.includes('meter') || 
                                   lower.includes('reading') || 
                                   lower.includes('consumption') ||
                                   lower.includes('present') ||
                                   lower.includes('previous');
                        });
                        
                        if (hasReadingFields) {
                            readingCollections.push({name: coll, fields, docs: snap.docs.map(d => d.data())});
                        }
                        
                        const readingFieldsList = fields.filter(f => {
                            const lower = f.toLowerCase();
                            return lower.includes('meter') || lower.includes('reading') || 
                                   lower.includes('consumption') || lower.includes('present') || lower.includes('previous');
                        });
                        
                        html += `<tr class="${hasReadingFields ? 'highlight' : ''}">
                            <td><strong>${coll}</strong></td>
                            <td>${snap.size}+</td>
                            <td>${hasReadingFields ? '‚úÖ YES' : '-'}</td>
                            <td style="font-size:0.75rem">${readingFieldsList.length > 0 ? readingFieldsList.join(', ') : fields.slice(0,8).join(', ')}...</td>
                        </tr>`;
                    }
                } catch(e) {
                    // Collection doesn't exist or error
                }
            }
            
            html += '</table></div>';
            
            // Show collections with reading fields
            if (readingCollections.length > 0) {
                html += '<div class="card">';
                html += '<h2>üìç Collections with Meter/Reading Fields</h2>';
                
                for (const rc of readingCollections) {
                    html += `<h3>${rc.name}</h3>`;
                    html += `<p>Fields: ${rc.fields.join(', ')}</p>`;
                    html += `<pre>${JSON.stringify(rc.docs[0], null, 2)}</pre>`;
                }
                html += '</div>';
            } else {
                html += '<div class="card">';
                html += '<p class="not-found">‚ùå No billing/invoice history table found with meter reading fields!</p>';
                html += '<p class="warn">‚ö†Ô∏è The billing history table may need to be migrated from MySQL to Firebase.</p>';
                html += '</div>';
            }
            
            // Summary
            html += '<div class="card">';
            html += '<h2>Summary</h2>';
            html += `<p>Total collections found: <strong>${foundCollections.length}</strong></p>`;
            html += `<p>Collections: ${foundCollections.join(', ')}</p>`;
            html += '</div>';
            
            output.innerHTML = html;
        }
        
        search();
    </script>
</body>
</html>
