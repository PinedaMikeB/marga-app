<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find Previous Reading Source</title>
    <style>
        body { font-family: system-ui; padding: 2rem; background: #f5f5f5; }
        pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 500px; }
        .found { background: #22c55e; color: white; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; }
        .searching { color: #6b7280; }
        h2 { color: #1e3a5f; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h1>üîç Finding Previous Reading: 71075</h1>
    <p>Searching for "Infinity Internet and Printing Services" and value 71075...</p>
    
    <div id="output">
        <p class="searching">Searching...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shared/js/firebase-config.js"></script>
    <script>
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Collections that might contain billing/reading history
        const collectionsToSearch = [
            'tbl_invoice',
            'tbl_invoices', 
            'tbl_billing',
            'tbl_billings',
            'tbl_reading',
            'tbl_readings',
            'tbl_meterreading',
            'tbl_meter_reading',
            'tbl_billing_history',
            'tbl_invoice_history',
            'tbl_transaction',
            'tbl_transactions',
            'tbl_sales',
            'tbl_collection',
            'tbl_collections',
            'tbl_payment',
            'tbl_payments',
            'tbl_history',
            'tbl_contracthistory',
            'tbl_contract_history',
            'tbl_machinehistory',
            'tbl_reading_history',
            'tbl_inv',
            'tbl_invdetail',
            'tbl_inv_detail',
            'tbl_invoicedetail',
            'tbl_invoice_detail',
            'tbl_billdetail',
            'tbl_bill_detail',
            'tbl_ar',
            'tbl_receivable',
            'tbl_receivables'
        ];

        async function search() {
            const output = document.getElementById('output');
            let html = '';
            
            // First, find Infinity Internet contract
            html += '<div class="card"><h2>Step 1: Find Infinity Internet Contract</h2>';
            
            const contractsSnap = await db.collection('tbl_contractmain').get();
            const contracts = contractsSnap.docs.map(d => ({id: d.id, ...d.data()}));
            
            // Get branches to find Infinity
            const branchesSnap = await db.collection('tbl_branchinfo').get();
            const branches = branchesSnap.docs.map(d => ({id: d.id, ...d.data()}));
            
            const companiesSnap = await db.collection('tbl_companylist').get();
            const companies = companiesSnap.docs.map(d => ({id: d.id, ...d.data()}));
            
            // Find Infinity company
            const infinityCompany = companies.find(c => 
                c.companyname && c.companyname.toLowerCase().includes('infinity')
            );
            
            if (infinityCompany) {
                html += `<p class="found">‚úÖ Found Company: ${infinityCompany.companyname} (ID: ${infinityCompany.id})</p>`;
                
                // Find branches for this company
                const infinityBranches = branches.filter(b => b.company_id == infinityCompany.id);
                html += `<p>Branches: ${infinityBranches.length}</p>`;
                
                // Find contracts for these branches
                const branchIds = infinityBranches.map(b => b.id);
                const infinityContracts = contracts.filter(c => branchIds.includes(c.contract_id));
                html += `<p>Contracts: ${infinityContracts.length}</p>`;
                
                if (infinityContracts.length > 0) {
                    html += `<p>Contract IDs: ${infinityContracts.map(c => c.id).join(', ')}</p>`;
                    html += `<pre>${JSON.stringify(infinityContracts[0], null, 2)}</pre>`;
                }
            }
            html += '</div>';
            
            // Search for 71075 in all possible tables
            html += '<div class="card"><h2>Step 2: Search for value 71075 in billing tables</h2>';
            
            for (const coll of collectionsToSearch) {
                try {
                    const snap = await db.collection(coll).limit(5).get();
                    if (!snap.empty) {
                        html += `<p class="found">‚úÖ Collection exists: ${coll} (${snap.size}+ records)</p>`;
                        
                        // Get all fields
                        const allFields = new Set();
                        snap.docs.forEach(d => Object.keys(d.data()).forEach(k => allFields.add(k)));
                        
                        // Check for reading-related fields
                        const fields = Array.from(allFields);
                        const readingFields = fields.filter(f => 
                            f.toLowerCase().includes('read') || 
                            f.toLowerCase().includes('meter') ||
                            f.toLowerCase().includes('prev') ||
                            f.toLowerCase().includes('present') ||
                            f.toLowerCase().includes('consumption')
                        );
                        
                        if (readingFields.length > 0) {
                            html += `<p style="color:green">üìç Reading fields: ${readingFields.join(', ')}</p>`;
                        }
                        
                        html += `<p style="font-size:0.8rem;color:#666">All fields: ${fields.join(', ')}</p>`;
                        
                        // Show sample
                        html += `<pre>${JSON.stringify(snap.docs[0].data(), null, 2)}</pre>`;
                    }
                } catch(e) {
                    // Collection doesn't exist
                }
            }
            
            html += '</div>';
            
            // Also search in contractmain for any field with 71075
            html += '<div class="card"><h2>Step 3: Search contracts for 71075</h2>';
            
            const matchingContracts = contracts.filter(c => {
                return Object.values(c).some(v => 
                    v == 71075 || v == '71075' || 
                    (typeof v === 'string' && v.includes('71075'))
                );
            });
            
            if (matchingContracts.length > 0) {
                html += `<p class="found">‚úÖ Found ${matchingContracts.length} contracts with 71075</p>`;
                html += `<pre>${JSON.stringify(matchingContracts, null, 2)}</pre>`;
            } else {
                html += `<p>No contracts contain 71075 - it must be in a separate billing/invoice table</p>`;
            }
            
            html += '</div>';
            
            output.innerHTML = html;
        }
        
        search();
    </script>
</body>
</html>
