<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARGA - Company ID Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; padding: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #1e3a5f; margin-bottom: 0.5rem; }
        .subtitle { color: #64748b; margin-bottom: 2rem; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h2 { font-size: 1rem; color: #334155; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; color: #64748b; font-size: 0.7rem; text-transform: uppercase; }
        tr:hover { background: #f1f5f9; }
        .highlight { background: #fef3c7 !important; }
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-success { background: #d1fae5; color: #166534; }
        .loading { text-align: center; padding: 3rem; color: #64748b; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat { background: #f8fafc; padding: 1rem; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #2563eb; }
        .stat-label { font-size: 0.8rem; color: #64748b; }
        .stat.danger .stat-value { color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Company ID Analysis</h1>
        <p class="subtitle">Understanding why branches are linked to wrong companies</p>

        <div class="stat-grid" id="stats">
            <div class="stat">
                <div class="stat-value" id="totalCompanies">-</div>
                <div class="stat-label">Total Companies</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalBranches">-</div>
                <div class="stat-label">Total Branches</div>
            </div>
            <div class="stat danger">
                <div class="stat-value" id="companyId1Count">-</div>
                <div class="stat-label">Branches with company_id = 1</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="companyId1Name">-</div>
                <div class="stat-label">Company ID 1 Name</div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Branches Per Company (Top 20 by branch count)</h2>
            <div id="branchCountTable"><div class="loading">Loading...</div></div>
        </div>

        <div class="card">
            <h2>‚ö†Ô∏è All Branches Linked to Company ID = 1</h2>
            <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">
                These branches might be incorrectly linked. Company ID 1 is often used as a default.
            </p>
            <div id="companyId1Table"><div class="loading">Loading...</div></div>
        </div>

        <div class="card">
            <h2>üîé Company ID Distribution</h2>
            <div id="distributionInfo"><div class="loading">Loading...</div></div>
        </div>
    </div>

    <script src="shared/js/firebase-config.js"></script>
    <script src="shared/js/utils.js"></script>
    <script>
        let companies = [];
        let branches = [];

        async function init() {
            try {
                [companies, branches] = await Promise.all([
                    MargaUtils.fetchCollection('tbl_companylist'),
                    MargaUtils.fetchCollection('tbl_branchinfo')
                ]);

                document.getElementById('totalCompanies').textContent = companies.length;
                document.getElementById('totalBranches').textContent = branches.length;

                analyze();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function analyze() {
            // Create company map
            const companyMap = {};
            companies.forEach(c => companyMap[c.id] = c);

            // Find company with ID = 1
            const company1 = companyMap[1];
            document.getElementById('companyId1Name').textContent = company1?.companyname || 'NOT FOUND';
            document.getElementById('companyId1Name').style.fontSize = '0.9rem';

            // Count branches per company_id
            const branchCounts = {};
            branches.forEach(b => {
                const cid = b.company_id || 'NULL';
                branchCounts[cid] = (branchCounts[cid] || 0) + 1;
            });

            // Branches with company_id = 1
            const id1Branches = branches.filter(b => b.company_id == 1);
            document.getElementById('companyId1Count').textContent = id1Branches.length;

            // Render branch count table (top 20)
            const sorted = Object.entries(branchCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);

            let countHtml = `<table><thead><tr><th>Company ID</th><th>Company Name</th><th>Branch Count</th><th>Status</th></tr></thead><tbody>`;
            sorted.forEach(([cid, count]) => {
                const company = companyMap[cid];
                const isProblematic = count > 10 && cid == 1;
                countHtml += `
                    <tr class="${isProblematic ? 'highlight' : ''}">
                        <td>${cid}</td>
                        <td>${escapeHtml(company?.companyname || 'NOT FOUND')}</td>
                        <td><strong>${count}</strong></td>
                        <td>${isProblematic ? '<span class="badge badge-danger">Likely has wrong branches</span>' : 
                             count > 20 ? '<span class="badge badge-warning">Review recommended</span>' : 
                             '<span class="badge badge-success">Normal</span>'}</td>
                    </tr>
                `;
            });
            countHtml += '</tbody></table>';
            document.getElementById('branchCountTable').innerHTML = countHtml;

            // Render company_id = 1 branches
            let id1Html = `<table><thead><tr><th>Branch ID</th><th>Branch Name</th><th>Signatory</th><th>Address</th></tr></thead><tbody>`;
            id1Branches.slice(0, 50).forEach(b => {
                const looksLikeCompany = /inc|corp|ltd|philippines|services|enterprises/i.test(b.branchname || '');
                id1Html += `
                    <tr class="${looksLikeCompany ? 'highlight' : ''}">
                        <td>${b.id}</td>
                        <td><strong>${escapeHtml(b.branchname || 'N/A')}</strong></td>
                        <td>${escapeHtml(b.signatory || 'N/A')}</td>
                        <td>${escapeHtml([b.bldg, b.street, b.city].filter(Boolean).join(', ') || 'N/A')}</td>
                    </tr>
                `;
            });
            if (id1Branches.length > 50) {
                id1Html += `<tr><td colspan="4" style="text-align:center; color:#64748b;">... and ${id1Branches.length - 50} more</td></tr>`;
            }
            id1Html += '</tbody></table>';
            document.getElementById('companyId1Table').innerHTML = id1Html;

            // Distribution info
            const uniqueCompanyIds = Object.keys(branchCounts).length;
            const orphanCount = branches.filter(b => !companyMap[b.company_id]).length;
            const nullCount = branches.filter(b => !b.company_id).length;
            
            document.getElementById('distributionInfo').innerHTML = `
                <ul style="line-height: 2; color: #334155;">
                    <li><strong>${uniqueCompanyIds}</strong> unique company_id values found in branches</li>
                    <li><strong>${companies.length}</strong> companies exist in tbl_companylist</li>
                    <li><strong>${orphanCount}</strong> branches reference non-existent company IDs</li>
                    <li><strong>${nullCount}</strong> branches have NULL/empty company_id</li>
                    <li>Company ID <strong>1</strong> has <strong>${branchCounts[1] || 0}</strong> branches (${company1?.companyname || 'Unknown'})</li>
                </ul>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        init();
    </script>
</body>
</html>
