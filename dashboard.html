<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARGA - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared/css/styles.css">
    <link rel="stylesheet" href="shared/css/dashboard.css">
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
                    <rect width="40" height="40" rx="10" fill="url(#logo-gradient)"/>
                    <path d="M10 28V12h4l4 10 4-10h4v16h-3V17l-4 11h-2l-4-11v11h-3z" fill="white"/>
                    <defs>
                        <linearGradient id="logo-gradient" x1="0" y1="0" x2="40" y2="40">
                            <stop stop-color="#3b82f6"/>
                            <stop offset="1" stop-color="#1d4ed8"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="logo-text">MARGA<span>.</span></span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-title">Main Menu</div>

                <a href="dashboard.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <span>Dashboard</span>
                </a>

                <a href="customers.html" class="nav-item" data-module="customers">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                    <span>Customers</span>
                </a>

                <a href="billing/" class="nav-item" data-module="billing">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    <span>Billing</span>
                </a>

                <a href="collections.html" class="nav-item" data-module="collections">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2"/>
                        <path d="M1 10h22"/>
                    </svg>
                    <span>Collections</span>
                </a>

                <a href="service/index.html" class="nav-item" data-module="service">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                    </svg>
                    <span>Service</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">Management</div>

                <a href="inventory/" class="nav-item" data-module="inventory">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/>
                        <path d="M3.27 6.96L12 12.01l8.73-5.05M12 22.08V12"/>
                    </svg>
                    <span>Inventory</span>
                </a>

                <a href="hr/" class="nav-item" data-module="hr">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                        <circle cx="8.5" cy="7" r="4"/>
                        <path d="M20 8v6M23 11h-6"/>
                    </svg>
                    <span>Human Resource</span>
                </a>

                <a href="reports/" class="nav-item" data-module="reports">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10M12 20V4M6 20v-6"/>
                    </svg>
                    <span>Reports</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">System</div>

                <a href="settings/index.html" class="nav-item" data-module="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                    <span>Settings</span>
                </a>

                <a href="sync/index.html" class="nav-item" data-module="sync">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6"/>
                        <path d="M1 20v-6h6"/>
                        <path d="M3.5 9a9 9 0 0114.13-3.36L23 10"/>
                        <path d="M20.5 15a9 9 0 01-14.13 3.36L1 14"/>
                    </svg>
                    <span>Sync Updater</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role" id="userRole">Administrator</div>
                </div>
                <button class="logout-btn" onclick="MargaAuth.logout()" title="Logout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/>
                    </svg>
                </button>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12h18M3 6h18M3 18h18"/>
                </svg>
            </button>
            <div class="header-title">
                <h1 id="dashboardTitle">Dashboard</h1>
                <p id="dashboardSubtitle">Welcome back! Here's your business overview.</p>
            </div>
            <div class="header-actions">
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" placeholder="Search...">
                </div>
            </div>
        </header>

        <div class="dashboard-content">
            <section id="adminAnalyticsSection">
                <div class="section-header">
                    <h2>Admin Analytics</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card animate-in" style="animation-delay: 0.1s">
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="statCustomers">-</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.2s">
                        <div class="stat-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="3" width="20" height="14" rx="2"/>
                                <path d="M8 21h8M12 17v4"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="statMachines">-</div>
                            <div class="stat-label">Machines Deployed</div>
                        </div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.3s">
                        <div class="stat-icon amber">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <path d="M14 2v6h6"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="statContracts">-</div>
                            <div class="stat-label">Active Contracts</div>
                        </div>
                    </div>
                    <div class="stat-card animate-in" style="animation-delay: 0.4s">
                        <div class="stat-icon cyan">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2"/>
                                <path d="M1 10h22"/>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="statPending">-</div>
                            <div class="stat-label">Pending Collections</div>
                        </div>
                    </div>
                </div>
                <div class="content-card dashboard-admin-note">
                    <div class="card-header">
                        <h3>Operations Control Center</h3>
                        <a href="service/index.html" class="btn btn-secondary btn-sm">Open Service Dispatch Board</a>
                    </div>
                </div>
            </section>

            <section id="workspaceSection">
                <div class="section-header">
                    <h2 id="workspaceTitle">Department Workspace</h2>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <h3 id="workspaceSubtitle">Choose your module to manage today's tasks.</h3>
                    </div>
                    <div class="department-grid" id="departmentTiles"></div>
                </div>
            </section>

            <section id="quickActionsSection">
                <div class="section-header">
                    <h2>Quick Actions</h2>
                </div>
                <div class="quick-actions" id="quickActionsGrid">
                    <a href="customers.html" class="action-card" data-module="customers">
                        <div class="action-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <path d="M20 8v6M23 11h-6"/>
                            </svg>
                        </div>
                        <span>Add Customer</span>
                    </a>

                    <a href="billing/" class="action-card" data-module="billing">
                        <div class="action-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <path d="M14 2v6h6M12 18v-6M9 15h6"/>
                            </svg>
                        </div>
                        <span>New Invoice</span>
                    </a>

                    <a href="collections.html" class="action-card" data-module="collections">
                        <div class="action-icon amber">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M2 12h20"/>
                            </svg>
                        </div>
                        <span>Record Payment</span>
                    </a>

                    <a href="service/index.html" class="action-card" data-module="service">
                        <div class="action-icon red">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                            </svg>
                        </div>
                        <span>Service Dispatch</span>
                    </a>
                </div>
            </section>

            <section id="recentActivitySection">
                <div class="section-header">
                    <h2>Recent Activity</h2>
                    <a href="reports/" class="view-all">View All</a>
                </div>
                <div class="activity-card">
                    <div class="activity-list" id="activityList">
                        <div class="activity-loading">
                            <div class="spinner"></div>
                            <span>Loading recent activity...</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

	    <script src="shared/js/firebase-config.js"></script>
	    <script src="shared/js/auth.js"></script>
	    <script src="shared/js/utils.js"></script>
	    <script>
	        if (!MargaAuth.requireAuth()) {}

	        // Field-only roles should never land on the admin/department dashboard.
	        // They are redirected to the Field App home.
	        const bootUser = MargaAuth.getUser();
	        const bootRole = bootUser?.role || 'viewer';
	        if (bootRole === 'technician' || bootRole === 'messenger') {
	            window.location.href = MargaAuth.buildAppUrl('field/index.html');
	        }

	        const MODULE_TILE_CONFIG = {
	            customers: { label: 'Customers', href: 'customers.html', note: 'Profiles, branches, machines' },
	            billing: { label: 'Billing', href: 'billing/', note: 'Invoices, billing runs, due schedules' },
	            collections: { label: 'Collections', href: 'collections.html', note: 'Collections, ORs, check follow-up' },
	            service: { label: 'Service Dispatch', href: 'service/index.html', note: 'Task queue, assignment, transfer' },
	            inventory: { label: 'Inventory', href: 'inventory/', note: 'Parts, toner, stock movements' },
	            hr: { label: 'Human Resource', href: 'hr/', note: 'Employees, position mapping' },
	            reports: { label: 'Reports', href: 'reports/', note: 'Daily and historical reports' },
	            settings: { label: 'Settings', href: 'settings/index.html', note: 'Users, permissions, app config' },
	            sync: { label: 'Sync Updater', href: 'sync/index.html', note: 'SQL to Firebase updates' }
	        };

        document.addEventListener('DOMContentLoaded', () => {
            const user = MargaAuth.getUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
                document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
            }

            applyModulePermissions();
            renderDepartmentTiles();
            applyRoleLayout(user?.role || 'viewer');
            loadDashboardData(user?.role || 'viewer');
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function applyModulePermissions() {
            document.querySelectorAll('[data-module]').forEach((el) => {
                const module = el.dataset.module;
                if (!module) return;
                if (!MargaAuth.hasAccess(module)) {
                    if (el.classList.contains('action-card') || el.classList.contains('department-tile')) {
                        el.style.display = 'none';
                        return;
                    }
                    el.classList.add('disabled');
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        alert('You do not have permission to access this module.');
                    });
                }
            });
        }

        function applyRoleLayout(role) {
            const isAdmin = role === 'admin';
            const adminSection = document.getElementById('adminAnalyticsSection');
            const recentActivity = document.getElementById('recentActivitySection');
            const title = document.getElementById('dashboardTitle');
            const subtitle = document.getElementById('dashboardSubtitle');

            adminSection.style.display = isAdmin ? '' : 'none';
            recentActivity.style.display = isAdmin ? '' : 'none';

            if (isAdmin) {
                title.textContent = 'Dashboard';
                subtitle.textContent = 'Administrator overview across all departments.';
                document.getElementById('workspaceTitle').textContent = 'Department Workspace';
                document.getElementById('workspaceSubtitle').textContent = 'Use role-based modules below. Admin can open all departments.';
            } else {
                title.textContent = 'Workspace';
                subtitle.textContent = 'Department view only. Use your assigned module below.';
                document.getElementById('workspaceTitle').textContent = 'My Department';
                document.getElementById('workspaceSubtitle').textContent = 'You only see the modules allowed for your role.';
            }
        }

        function loadDashboardData(role) {
            if (role === 'admin') {
                animateNumber('statCustomers', 1143);
                animateNumber('statMachines', 3602);
                animateNumber('statContracts', 4600);
                animateNumber('statPending', 55);
            }
            loadRecentActivity(role);
        }

        function animateNumber(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const duration = 1000;
            const startTime = performance.now();

            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentValue = Math.round(targetValue * easeOut);
                element.textContent = currentValue.toLocaleString();
                if (progress < 1) requestAnimationFrame(animate);
            };

            requestAnimationFrame(animate);
        }

        function renderDepartmentTiles() {
            const container = document.getElementById('departmentTiles');
            const modules = MargaAuth.getAccessibleModules();

            container.innerHTML = modules
                .filter((module) => MODULE_TILE_CONFIG[module])
                .map((module) => {
                    const tile = MODULE_TILE_CONFIG[module];
                    return `
                        <a href="${tile.href}" class="department-tile" data-module="${module}">
                            <div class="department-name">${MargaUtils.escapeHtml(tile.label)}</div>
                            <div class="department-note">${MargaUtils.escapeHtml(tile.note)}</div>
                        </a>
                    `;
                })
                .join('');

            if (!container.innerHTML.trim()) {
                container.innerHTML = '<div class="department-empty">No department modules are assigned to your account.</div>';
            }
        }

        function loadRecentActivity(role) {
            const activityList = document.getElementById('activityList');
            if (!activityList) return;

            if (role !== 'admin') {
                activityList.innerHTML = '';
                return;
            }

            activityList.innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                        </svg>
                    </div>
                    <div class="activity-info">
                        <div class="activity-text">Unified operations and task queue are now managed in <strong>Service Dispatch Board</strong>.</div>
                        <div class="activity-time">Updated today</div>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M2 12h20"/>
                        </svg>
                    </div>
                    <div class="activity-info">
                        <div class="activity-text">Non-admin accounts now see only their department workspace and allowed modules.</div>
                        <div class="activity-time">Access policy applied</div>
                    </div>
                </div>
            `;
        }

        window.toggleSidebar = toggleSidebar;
    </script>
</body>
</html>
