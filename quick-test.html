<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quick Test - Data Load</title>
    <style>
        body { font-family: system-ui; padding: 20px; }
        .log { background: #1e1e1e; color: #0f0; padding: 15px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 600px; overflow-y: auto; }
        button { background: #e91e8c; color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; margin: 10px; }
    </style>
</head>
<body>
    <h1>Quick Test - Why Is Company Unknown?</h1>
    <button onclick="runTest()">Run Full Test</button>
    <div class="log" id="log"></div>

    <script src="shared/js/firebase-config.js"></script>
    <script>
        const API_KEY = FIREBASE_CONFIG.apiKey;
        const BASE_URL = FIREBASE_CONFIG.baseUrl;

        function log(msg) {
            document.getElementById('log').textContent += msg + '\n';
            console.log(msg);
        }

        function getValue(field) {
            if (!field) return null;
            return field.integerValue || field.stringValue || field.doubleValue || field.booleanValue || null;
        }

        async function firestoreGetAll(collection) {
            let allDocs = [];
            let pageToken = null;
            let page = 0;
            
            while (true) {
                let url = `${BASE_URL}/${collection}?pageSize=500&key=${API_KEY}`;
                if (pageToken) url += `&pageToken=${pageToken}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.documents) {
                    allDocs = allDocs.concat(data.documents);
                }
                page++;
                log(`  ${collection}: page ${page}, total so far: ${allDocs.length}`);
                
                if (!data.nextPageToken || !data.documents || data.documents.length < 500) {
                    break;
                }
                pageToken = data.nextPageToken;
            }
            
            return allDocs;
        }

        async function runTest() {
            document.getElementById('log').textContent = '';
            
            log('=== STARTING FULL TEST ===\n');

            // 1. Load ONE billing record
            log('1. Loading one billing record...');
            let url = `${BASE_URL}/tbl_billing?pageSize=1&key=${API_KEY}`;
            let resp = await fetch(url);
            let data = await resp.json();
            let billing = data.documents[0].fields;
            
            const billingId = getValue(billing.id);
            const contractmainId = getValue(billing.contractmain_id);
            log(`   Billing ID: ${billingId}`);
            log(`   contractmain_id: ${contractmainId}`);

            // 2. Load ALL contracts
            log('\n2. Loading ALL contracts...');
            const contracts = await firestoreGetAll('tbl_contractmain');
            log(`   Total contracts loaded: ${contracts.length}`);
            
            // Build contract map
            const contractMap = {};
            contracts.forEach(doc => {
                const id = getValue(doc.fields.id);
                contractMap[id] = {
                    branch_id: getValue(doc.fields.contract_id),
                    category_id: getValue(doc.fields.category_id)
                };
            });
            
            // Check if our contract exists
            log(`\n3. Looking for contract ID ${contractmainId}...`);
            const contract = contractMap[contractmainId];
            if (contract) {
                log(`   ✅ FOUND! branch_id (contract_id): ${contract.branch_id}`);
            } else {
                log(`   ❌ NOT FOUND!`);
                log(`   Contract IDs in map: ${Object.keys(contractMap).slice(0, 20).join(', ')}...`);
                log(`   Total keys: ${Object.keys(contractMap).length}`);
                
                // Check if it's a string/number issue
                log(`\n   Checking type issues...`);
                log(`   Looking for "${contractmainId}" (string)`);
                log(`   Looking for ${parseInt(contractmainId)} (number)`);
                
                // Try both
                if (contractMap[String(contractmainId)]) {
                    log(`   Found as STRING!`);
                }
                if (contractMap[parseInt(contractmainId)]) {
                    log(`   Found as NUMBER!`);
                }
                
                return;
            }

            // 4. Load branches and find the branch
            log('\n4. Loading branches...');
            const branches = await firestoreGetAll('tbl_branchinfo');
            log(`   Total branches: ${branches.length}`);
            
            const branchMap = {};
            branches.forEach(doc => {
                const id = getValue(doc.fields.id);
                branchMap[id] = {
                    name: getValue(doc.fields.branchname),
                    company_id: getValue(doc.fields.company_id)
                };
            });
            
            log(`\n5. Looking for branch ID ${contract.branch_id}...`);
            const branch = branchMap[contract.branch_id];
            if (branch) {
                log(`   ✅ FOUND! name: "${branch.name}", company_id: ${branch.company_id}`);
            } else {
                log(`   ❌ Branch NOT FOUND!`);
                return;
            }

            // 5. Load companies
            log('\n6. Loading companies...');
            const companies = await firestoreGetAll('tbl_companylist');
            log(`   Total companies: ${companies.length}`);
            
            const companyMap = {};
            companies.forEach(doc => {
                const id = getValue(doc.fields.id);
                companyMap[id] = getValue(doc.fields.companyname);
            });
            
            log(`\n7. Looking for company ID ${branch.company_id}...`);
            const companyName = companyMap[branch.company_id];
            if (companyName) {
                log(`   ✅ FOUND! Company name: "${companyName}"`);
            } else {
                log(`   ❌ Company NOT FOUND!`);
            }

            log('\n=== TEST COMPLETE ===');
            log(`\nFinal result for billing ${billingId}:`);
            log(`   Company: ${companyName || 'Unknown'}`);
            log(`   Branch: ${branch?.name || 'Unknown'}`);
        }
    </script>
</body>
</html>
