<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search Serial LP06524672</title>
    <style>
        body { font-family: system-ui; padding: 2rem; background: #f5f5f5; }
        pre { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 8px; overflow: auto; max-height: 500px; }
        .found { background: #22c55e; color: white; padding: 0.5rem 1rem; border-radius: 4px; margin: 0.5rem 0; display: inline-block; }
        .not-found { background: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 4px; }
        h2 { color: #1e3a5f; margin-top: 2rem; }
        .card { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h1>üîç Search for Serial: LP06524672</h1>
    <p>Contract 939, Invoice 130000</p>
    
    <div id="output">
        <p>Searching...</p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shared/js/firebase-config.js"></script>
    <script>
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        async function search() {
            const output = document.getElementById('output');
            let html = '';
            
            // Load all data
            const [machinesSnap, contractsSnap, branchesSnap, companiesSnap] = await Promise.all([
                db.collection('tbl_machine').get(),
                db.collection('tbl_contractmain').get(),
                db.collection('tbl_branchinfo').get(),
                db.collection('tbl_companylist').get()
            ]);
            
            const machines = machinesSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            const contracts = contractsSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            const branches = branchesSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            const companies = companiesSnap.docs.map(d => ({docId: d.id, ...d.data()}));
            
            // Search for serial LP06524672
            html += '<div class="card">';
            html += '<h2>Step 1: Search for machine serial LP06524672</h2>';
            
            const foundMachine = machines.find(m => 
                m.serial && m.serial.toUpperCase().includes('LP06524672')
            );
            
            if (foundMachine) {
                html += `<p class="found">‚úÖ Found Machine ID: ${foundMachine.id}</p>`;
                html += `<pre>${JSON.stringify(foundMachine, null, 2)}</pre>`;
            } else {
                html += `<p class="not-found">‚ùå Not found in tbl_machine</p>`;
            }
            html += '</div>';
            
            // Search contract ID 939
            html += '<div class="card">';
            html += '<h2>Step 2: Search for Contract ID 939</h2>';
            
            const contract939 = contracts.find(c => c.id == 939);
            
            if (contract939) {
                html += `<p class="found">‚úÖ Found Contract 939</p>`;
                
                const branch = branches.find(b => b.id == contract939.contract_id);
                const company = branch ? companies.find(c => c.id == branch.company_id) : null;
                const machine = machines.find(m => m.id == contract939.mach_id);
                
                html += `<p>Company: <strong>${company?.companyname || 'Unknown'}</strong></p>`;
                html += `<p>Branch: ${branch?.branchname || 'Unknown'}</p>`;
                html += `<p>Machine ID: ${contract939.mach_id}</p>`;
                html += `<p>Machine Serial: <strong>${machine?.serial || contract939.xserial || 'N/A'}</strong></p>`;
                html += `<p>Reading Day (rd): <strong>${contract939.rd || 'N/A'}</strong></p>`;
                html += `<p>b_meter: <strong>${contract939.b_meter || 'N/A'}</strong></p>`;
                html += `<p>starting_meter: <strong>${contract939.starting_meter || 'N/A'}</strong></p>`;
                
                html += '<h4>Full Contract Record:</h4>';
                html += `<pre>${JSON.stringify(contract939, null, 2)}</pre>`;
                
                if (machine) {
                    html += '<h4>Machine Record:</h4>';
                    html += `<pre>${JSON.stringify(machine, null, 2)}</pre>`;
                }
            } else {
                html += `<p class="not-found">‚ùå Contract 939 not found</p>`;
            }
            html += '</div>';
            
            // Search for invoice 130000
            html += '<div class="card">';
            html += '<h2>Step 3: Search ALL tables for Invoice 130000 or value 71075</h2>';
            
            // Search in all contracts for any reference to 130000 or 71075
            const contractsWithInvoice = contracts.filter(c => {
                return Object.values(c).some(v => 
                    v == 130000 || v == '130000' || v == 71075 || v == '71075'
                );
            });
            
            if (contractsWithInvoice.length > 0) {
                html += `<p class="found">‚úÖ Found ${contractsWithInvoice.length} contracts with 130000 or 71075</p>`;
                contractsWithInvoice.forEach(c => {
                    html += `<pre>${JSON.stringify(c, null, 2)}</pre>`;
                });
            } else {
                html += `<p>No contracts contain 130000 or 71075</p>`;
            }
            html += '</div>';
            
            // Search all collections for these values
            html += '<div class="card">';
            html += '<h2>Step 4: Search for billing/invoice tables</h2>';
            
            const tablesToCheck = [
                'tbl_invoice', 'tbl_invoices', 'tbl_billing', 'tbl_billings',
                'tbl_reading', 'tbl_readings', 'tbl_meterreading', 'tbl_transaction',
                'tbl_collection', 'tbl_ar', 'tbl_sales', 'tbl_history',
                'tbl_invheader', 'tbl_invdetail', 'tbl_billdetail'
            ];
            
            let foundTables = [];
            
            for (const tableName of tablesToCheck) {
                try {
                    const snap = await db.collection(tableName).limit(1).get();
                    if (!snap.empty) {
                        foundTables.push(tableName);
                        html += `<p class="found">‚úÖ ${tableName} exists</p>`;
                        
                        // Get sample record
                        const sample = snap.docs[0].data();
                        const fields = Object.keys(sample);
                        html += `<p>Fields: ${fields.join(', ')}</p>`;
                    }
                } catch(e) {
                    // Table doesn't exist
                }
            }
            
            if (foundTables.length === 0) {
                html += `<p class="not-found">‚ùå No billing/invoice tables found!</p>`;
                html += `<p><strong>The billing history table needs to be migrated from MySQL to Firebase.</strong></p>`;
                html += `<p>What is the table name in your VB.NET MySQL database that stores billing/invoice history?</p>`;
            }
            html += '</div>';
            
            output.innerHTML = html;
        }
        
        search();
    </script>
</body>
</html>
