<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Check Reading Day</title>
    <style>
        body { font-family: system-ui; padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .card { background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; }
        button { padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 8px; background: #2563eb; color: white; border: none; cursor: pointer; margin-right: 0.5rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.85rem; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #1e3a5f; color: white; position: sticky; top: 0; }
        .highlight { background: #fef3c7; font-weight: bold; }
        h1 { color: #1e3a5f; }
        .stat { display: inline-block; background: #dbeafe; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        #results { max-height: 500px; overflow: auto; }
        .day-29 { background: #dcfce7; }
    </style>
</head>
<body>
    <h1>ðŸ“… Check Reading Day (R. DAY)</h1>
    
    <div class="card">
        <p>Finding where R. DAY (1-31) comes from...</p>
        <button onclick="checkReadingDay()">Check Reading Day from Contracts</button>
        <button onclick="filterByDay(29)">Show Day 29 Only</button>
    </div>
    
    <div class="card">
        <h3>Results</h3>
        <div id="stats"></div>
        <div id="results"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="shared/js/firebase-config.js"></script>
    <script>
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();
        
        let allContracts = [];
        
        async function checkReadingDay() {
            document.getElementById('stats').innerHTML = 'Loading...';
            
            // Get contracts with status = 1 (active)
            const snap = await db.collection('tbl_contractmain').where('status', '==', 1).limit(200).get();
            allContracts = snap.docs.map(d => ({id: d.id, ...d.data()}));
            
            // Extract reading day from reading_date
            const withReadingDate = allContracts.filter(c => c.reading_date);
            
            // Count by day
            const dayCounts = {};
            withReadingDate.forEach(c => {
                let day;
                if (typeof c.reading_date === 'string') {
                    // Format: "YYYY-MM-DD"
                    day = parseInt(c.reading_date.split('-')[2]);
                } else if (c.reading_date.toDate) {
                    day = c.reading_date.toDate().getDate();
                } else {
                    day = new Date(c.reading_date).getDate();
                }
                c._readingDay = day;
                dayCounts[day] = (dayCounts[day] || 0) + 1;
            });
            
            // Sort by count
            const sortedDays = Object.entries(dayCounts).sort((a,b) => b[1] - a[1]);
            
            document.getElementById('stats').innerHTML = `
                <div class="stat">Active Contracts: ${allContracts.length}</div>
                <div class="stat">With reading_date: ${withReadingDate.length}</div>
                <br><br>
                <strong>Reading Days Distribution:</strong><br>
                ${sortedDays.map(([day, count]) => `<div class="stat">Day ${day}: ${count} contracts</div>`).join('')}
            `;
            
            renderTable(withReadingDate.slice(0, 100));
        }
        
        function filterByDay(day) {
            const filtered = allContracts.filter(c => c._readingDay === day);
            document.getElementById('stats').innerHTML += `<br><br><strong>Showing ${filtered.length} contracts for Day ${day}</strong>`;
            renderTable(filtered);
        }
        
        function renderTable(contracts) {
            document.getElementById('results').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="highlight">R. DAY</th>
                            <th>Contract ID</th>
                            <th>Machine ID</th>
                            <th>reading_date</th>
                            <th>Monthly Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${contracts.map(c => `
                            <tr class="${c._readingDay === 29 ? 'day-29' : ''}">
                                <td class="highlight">${c._readingDay || '-'}</td>
                                <td>${c.id}</td>
                                <td>${c.machine_id || '-'}</td>
                                <td>${c.reading_date || '-'}</td>
                                <td>${c.monthly_rate || '-'}</td>
                                <td>${c.status || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
    </script>
</body>
</html>
